<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Induksi Karyawan</title>
    <link rel="icon" href="https://i.imgur.com/2sQd5Xy.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tally Embed Script -->
    <script async src="https://tally.so/widgets/embed.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .step-card {
        transition: all 0.3s ease-in-out;
      }
      .locked {
        opacity: 0.5;
        pointer-events: none;
      }
      .step-header {
        cursor: pointer;
      }
      .step-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
      }
      .step-content.open {
        max-height: 4500px; /* Increased max-height for forms & images */
        transition: max-height 1.5s ease-in;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-left-color: #ffffff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .tally-embed {
        width: 100%;
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      /* Confetti Animation */
      .confetti-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        z-index: 999;
      }
      .confetti {
        position: absolute;
        width: 10px;
        height: 20px;
        opacity: 0.9;
        animation: fall 5s linear forwards;
      }
      @keyframes fall {
        to {
          transform: translateY(110vh) rotate(720deg);
          opacity: 0;
        }
      }
      /* Anti-Screenshot/Print Styles */
      @media print {
        body * {
          visibility: hidden;
        }
        #print-message,
        #print-message * {
          visibility: visible;
        }
        #print-message {
          position: fixed;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          font-weight: bold;
          color: black;
        }
      }
      .watermark {
        position: absolute;
        inset: 0;
        display: grid;
        grid-template-columns: repeat(
          2,
          1fr
        ); /* Mengurangi kolom untuk mengurangi frekuensi */
        gap: 80px; /* Menambah jarak antar item */
        padding: 20px;
        pointer-events: none;
        overflow: hidden;
        z-index: 1; /* Memastikan watermark di atas konten kartu */
      }
      .watermark-item {
        color: #000;
        opacity: 0.06; /* Membuat lebih transparan */
        font-size: 16px; /* Ukuran font diperkecil */
        font-weight: bold;
        transform: rotate(-30deg);
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
      <!-- Tombol Admin Login -->
      <button
        id="admin-login-btn"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </button>

      <div class="text-center mb-8 pt-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
          Sistem Induksi Keselamatan
        </h1>
        <p class="text-sm text-gray-600 mt-2">PT. Ganda Alam Makmur</p>
        <div
          id="online-status"
          class="mt-2 text-sm font-semibold rounded-full px-3 py-1 inline-block"
        ></div>
        <!-- Tombol Kembali ke Halaman Utama -->
        <div class="mt-4">
          <a
            href="index.html"
            class="text-blue-600 hover:text-blue-800 hover:underline font-semibold"
          >
            &larr; Kembali ke Halaman Utama
          </a>
        </div>
      </div>

      <div id="app-container" class="space-y-4">
        <!-- Langkah 0: Panduan Pengerjaan -->
        <div id="step-0" class="step-card bg-white p-6 rounded-xl shadow-md">
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 0: Panduan & Persetujuan
            </h2>
            <span id="step-0-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-0-content" class="step-content pt-4">
            <div class="w-full bg-white rounded-2xl p-2 md:p-6">
              <div class="text-center mb-12">
                <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800">
                  Panduan Pengerjaan Induksi Online
                </h1>
                <p class="text-base text-gray-600 mt-2">
                  ikuti 5 langkah mudah untuk mendapatkan sertifikat Anda.
                </p>
              </div>
              <div class="space-y-10">
                <div class="flex items-start space-x-6">
                  <div class="flex flex-col items-center">
                    <div
                      class="flex items-center justify-center w-12 h-12 bg-blue-500 text-white rounded-full text-xl font-bold shadow-md"
                    >
                      1
                    </div>
                    <div class="w-1 h-24 bg-blue-200 mt-2"></div>
                  </div>
                  <div class="flex-1 pt-1">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-7 w-7 text-blue-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                        />
                      </svg>
                      <h2 class="text-xl font-bold text-gray-800">
                        Isi Informasi Diri
                      </h2>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                      Lengkapi data Anda dengan benar untuk memulai proses.
                    </p>
                    <ul
                      class="list-disc list-inside mt-4 space-y-2 text-gray-700 text-sm"
                    >
                      <li>Lengkapi formulir NIK, Nama, Email, Jabatan, dll.</li>
                      <li>
                        Pilih perusahaan dari daftar, atau pilih "Lainnya" untuk
                        mengisi manual.
                      </li>
                      <li>
                        Tentukan jenis tes: <strong>Pre-Test</strong> atau
                        <strong>Post-Test</strong>.
                      </li>
                      <li>
                        Klik "Simpan & Lanjutkan" untuk menyimpan data Anda.
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="flex items-start space-x-6">
                  <div class="flex flex-col items-center">
                    <div
                      class="flex items-center justify-center w-12 h-12 bg-green-500 text-white rounded-full text-xl font-bold shadow-md"
                    >
                      2
                    </div>
                    <div class="w-1 h-24 bg-green-200 mt-2"></div>
                  </div>
                  <div class="flex-1 pt-1">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-7 w-7 text-green-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h2 class="text-xl font-bold text-gray-800">
                        Absensi & Pilih Induksi
                      </h2>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                      Catat kehadiran Anda dan pilih jenis induksi yang sesuai.
                    </p>
                    <ul
                      class="list-disc list-inside mt-4 space-y-2 text-gray-700 text-sm"
                    >
                      <li>Klik tombol "Lakukan Absensi".</li>
                      <li>
                        Pilih jenis induksi (Karyawan Baru, Pasca Cuti, Visitor,
                        dll.).
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="flex items-start space-x-6">
                  <div class="flex flex-col items-center">
                    <div
                      class="flex items-center justify-center w-12 h-12 bg-purple-500 text-white rounded-full text-xl font-bold shadow-md"
                    >
                      3
                    </div>
                    <div class="w-1 h-24 bg-purple-200 mt-2"></div>
                  </div>
                  <div class="flex-1 pt-1">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-7 w-7 text-purple-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h2 class="text-xl font-bold text-gray-800">
                        Kerjakan Kuis
                      </h2>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                      Fokus pada materi dan jawab semua pertanyaan.
                    </p>
                    <ul
                      class="list-disc list-inside mt-4 space-y-2 text-gray-700 text-sm"
                    >
                      <li>Tonton video materi yang ditampilkan.</li>
                      <li>
                        Centang kotak konfirmasi setelah menonton untuk membuka
                        soal.
                      </li>
                      <li>
                        Jawab semua pertanyaan yang diberikan. Pilihan jawaban
                        akan diacak.
                      </li>
                    </ul>
                  </div>
                </div>
                <div class="flex items-start space-x-6">
                  <div
                    class="flex items-center justify-center w-12 h-12 bg-red-500 text-white rounded-full text-xl font-bold shadow-md"
                  >
                    4
                  </div>
                  <div class="flex-1 pt-1 ml-6">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-7 w-7 text-red-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                        />
                      </svg>
                      <h2 class="text-xl font-bold text-gray-800">
                        Dapatkan Sertifikat
                      </h2>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                      Simpan bukti kelulusan Anda.
                    </p>
                    <ul
                      class="list-disc list-inside mt-4 space-y-2 text-gray-700 text-sm"
                    >
                      <li>
                        Lihat kartu induksi digital Anda yang berisi QR Code.
                      </li>
                      <li>
                        <strong>Screenshot</strong> halaman ini sebagai bukti
                        sementara.
                      </li>
                      <li>
                        Klik tombol
                        <strong>"Unduh Sertifikat (PDF)"</strong> untuk
                        menyimpan file resmi.
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="mt-12 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-bold text-center text-gray-800">
                  Catatan Penting
                </h3>
                <div class="mt-4 grid md:grid-cols-2 gap-6 text-center">
                  <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                    <h4
                      class="font-semibold text-red-700 flex items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 mr-2"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                        /></svg
                      >Jika Tidak Lulus
                    </h4>
                    <p class="text-red-600 text-sm mt-1">
                      Anda akan diberi pilihan untuk mengulang atau tetap
                      melanjutkan dengan persetujuan pengawas.
                    </p>
                  </div>
                  <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                    <h4
                      class="font-semibold text-blue-700 flex items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 mr-2"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071a10 10 0 0114.142 0M1.394 9.393a15 15 0 0121.212 0"
                        /></svg
                      >Koneksi Internet
                    </h4>
                    <p class="text-blue-600 text-sm mt-1">
                      Jika koneksi terputus, data Anda aman dan akan diunggah
                      otomatis saat kembali online.
                    </p>
                  </div>
                </div>
                <div
                  class="mt-6 bg-yellow-50 border border-yellow-300 p-4 rounded-lg text-center"
                >
                  <h4
                    class="font-bold text-yellow-800 flex items-center justify-center"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-6 w-6 mr-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    >PERINGATAN KERAHASIAAN
                  </h4>
                  <p class="text-yellow-700 text-sm mt-2">
                    Dilarang keras mengambil tangkapan layar (screenshot) soal
                    maupun jawaban. Jika terbukti melakukan pelanggaran, akan
                    diberikan sanksi SP1 dari tim PT GAM.
                  </p>
                </div>
              </div>
            </div>
            <div class="mt-8 pt-6 border-t">
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="guide-checkbox"
                  class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"
                />
                <span class="ml-3 text-gray-700 font-medium text-sm"
                  >Saya telah membaca dan memahami panduan pengerjaan di
                  atas.</span
                >
              </label>
              <button
                id="start-process-btn"
                class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-base"
                disabled
              >
                Lanjutkan ke Pengisian Data
              </button>
            </div>
          </div>
        </div>

        <!-- Langkah 1: Data Diri & Pilihan Test -->
        <div
          id="step-1"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 1: Informasi Peserta
            </h2>
            <span id="step-1-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-1-content" class="step-content pt-4">
            <form id="user-info-form" class="space-y-4">
              <input
                type="text"
                id="timestamp"
                name="timestamp"
                class="hidden"
              />
              <div>
                <label for="nik" class="block text-sm font-medium text-gray-700"
                  >NIK KTP</label
                >
                <input
                  type="text"
                  id="nik"
                  name="nik"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="nama"
                  class="block text-sm font-medium text-gray-700"
                  >Nama Lengkap</label
                >
                <input
                  type="text"
                  id="nama"
                  name="nama"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700"
                  >Email</label
                >
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="whatsapp"
                  class="block text-sm font-medium text-gray-700"
                  >No. WhatsApp</label
                >
                <input
                  type="tel"
                  id="whatsapp"
                  name="whatsapp"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="perusahaan-select"
                  class="block text-sm font-medium text-gray-700"
                  >Perusahaan</label
                >
                <select
                  id="perusahaan-select"
                  name="perusahaan-select"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="" disabled selected>Pilih Perusahaan</option>
                  <option value="PT. GAM">PT. GAM</option>
                  <option value="PT. KRI">PT. KRI</option>
                  <option value="PT. SUM">PT. SUM</option>
                  <option value="PT. DAUN BUAH">PT. DAUN BUAH</option>
                  <option value="PT. KAI">PT. KAI</option>
                  <option value="PT. GPE">PT. GPE</option>
                  <option value="PT. SMP">PT. SMP</option>
                  <option value="PT. INDEXIM COALINDO">
                    PT. INDEXIM COALINDO
                  </option>
                  <option value="PT. RPJ">PT. RPJ</option>
                  <option value="PT. SCI">PT. SCI</option>
                  <option value="PT. WEM">PT. WEM</option>
                  <option value="CV. AJS">CV. AJS</option>
                  <option value="PT. TRAKINDO UTAMA">PT. TRAKINDO UTAMA</option>
                  <option value="PT. GHJ">PT. GHJ</option>
                  <option value="PT. TEM">PT. TEM</option>
                  <option value="PT. HEXINDO ADIPERKASA">
                    PT. HEXINDO ADIPERKASA
                  </option>
                  <option value="PT. BELFANO">PT. BELFANO</option>
                  <option value="PT. BORNEO MELAWEN JAYA">
                    PT. BORNEO MELAWEN JAYA
                  </option>
                  <option value="PT. UT">PT. UT</option>
                  <option value="PT. BDE">PT. BDE</option>
                  <option value="PT. SUCOFINDO">PT. SUCOFINDO</option>
                  <option value="MAGANG / PKL / KKN">MAGANG / PKL / KKN</option>
                  <option value="PT. BAGONG">PT. BAGONG</option>
                  <option value="PT. PMJ">PT. PMJ</option>
                  <option value="Lainnya">Lainnya...</option>
                </select>
              </div>
              <div id="perusahaan-lainnya-container" class="hidden">
                <label
                  for="perusahaan-lainnya"
                  class="block text-sm font-medium text-gray-700"
                  >Nama Perusahaan Lainnya</label
                >
                <input
                  type="text"
                  id="perusahaan-lainnya"
                  name="perusahaan-lainnya"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="jabatan"
                  class="block text-sm font-medium text-gray-700"
                  >Jabatan</label
                >
                <select
                  id="jabatan"
                  name="jabatan"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="" disabled selected>Pilih Jabatan Anda</option>
                  <option value="pengawas">Pengawas / GL / SPV</option>
                  <option value="suptend">Superintendent / Manager</option>
                  <option value="safety">
                    HSE / SAFETY / PENGAWAS SAFETY / PATROL
                  </option>
                  <option value="non_pengawas">
                    Non Pengawas (Admin, Helper, dll)
                  </option>
                  <option value="driver">Driver Bus / Elf / Sarana</option>
                  <option value="mekanik">Mekanik</option>
                  <option value="operator">
                    Operator HD / DT / Dozzer / Exca / Rigger / dll.
                  </option>
                </select>
              </div>
              <button
                type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
              >
                Simpan & Lanjutkan
              </button>
            </form>
          </div>
        </div>

        <!-- Langkah 2: Absensi -->
        <div
          id="step-2"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">Langkah 2: Absensi</h2>
            <span id="step-2-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-2-content" class="step-content pt-4 text-center">
            <p class="text-gray-600 mb-4">
              Klik tombol di bawah untuk mencatat kehadiran Anda.
            </p>
            <button
              id="start-absensi-btn"
              class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Lakukan Absensi
            </button>
          </div>
        </div>

        <!-- Langkah 3: Pilih Jenis Induksi -->
        <div
          id="step-3"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 3: Pilih Jenis Induksi
            </h2>
            <span id="step-3-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-3-content" class="step-content pt-4">
            <p class="text-gray-600 mb-4">
              Pilih tipe pendaftaran sesuai dengan status Anda.
            </p>
            <select
              id="induction-type"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="" disabled selected>Pilih Tipe Induksi</option>
              <option value="induksi_visitor">Induksi Visitor</option>
              <option value="karyawan_baru">
                Karyawan Baru Mitra / PT.GAM
              </option>
              <option value="pasca_cuti_mitra">Pasca Cuti Mitra</option>
              <option value="pasca_cuti_gam">Pasca Cuti PT.GAM</option>
              <option value="temporary">Temporary</option>
              <option value="magang">Magang</option>
            </select>
            <button
              id="select-induction-btn"
              class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
            >
              Lanjutkan
            </button>
          </div>
        </div>

        <!-- LANGKAH 4: Pilih Jenis Tes -->
        <div
          id="step-4"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 4: Pilih Jenis Tes
            </h2>
            <span id="step-4-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-4-content" class="step-content pt-4">
            <p class="text-gray-600 mb-4">
              Pilih jenis tes yang akan Anda kerjakan.
            </p>
            <div class="mt-2 space-y-2">
              <label
                class="flex items-center p-3 border rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500"
              >
                <input
                  type="radio"
                  name="testType"
                  value="pre-test"
                  required
                  class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
                />
                <span class="ml-3 text-gray-700 font-medium">Pre-Test</span>
              </label>
              <label
                class="flex items-center p-3 border rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500"
              >
                <input
                  type="radio"
                  name="testType"
                  value="post-test"
                  required
                  class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
                />
                <span class="ml-3 text-gray-700 font-medium">Post-Test</span>
              </label>
            </div>
            <button
              id="confirm-test-type-btn"
              class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
            >
              Lanjutkan ke Kuis
            </button>
          </div>
        </div>

        <!-- LANGKAH 5: Kuis Umum -->
        <div
          id="step-5"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 5: Kuis Umum
            </h2>
            <span id="step-5-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-5-content" class="step-content pt-4 text-center">
            <p class="text-gray-600 mb-4">
              Sebelum melanjutkan, Anda wajib menyelesaikan kuis umum berikut
              ini.
            </p>
            <p id="general-quiz-error" class="hidden text-red-500"></p>
            <button
              id="start-general-quiz-btn"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Mulai Kuis Umum
            </button>
          </div>
        </div>

        <!-- Langkah 6: Kuis Spesifik -->
        <div
          id="step-6"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 6: Kuis Spesifik
            </h2>
            <span id="step-6-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-6-content" class="step-content pt-4 text-center">
            <p class="text-gray-600 mb-4">
              Sekarang kerjakan kuis yang sesuai dengan jenis induksi Anda.
            </p>
            <p id="specific-quiz-error" class="hidden text-red-500"></p>
            <button
              id="start-specific-quiz-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Mulai Kuis Spesifik
            </button>
          </div>
        </div>

        <!-- Langkah 7: Tanda Tangan -->
        <div
          id="step-7"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-700">
              Langkah 7: Tanda Tangan
            </h2>
            <span id="step-7-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-7-content" class="step-content pt-4 space-y-4">
            <!-- SPDK Preview Section -->
            <div id="spdk-preview-section">
              <h3 class="text-lg font-semibold text-gray-800 mb-2">
                1. Pratinjau Dokumen
              </h3>
              <p class="text-gray-600 mb-4">
                Harap baca dan pahami dokumen di bawah ini sebelum memberikan
                tanda tangan.
              </p>
              <div
                class="border rounded-lg p-4 space-y-4 bg-gray-50 max-h-96 overflow-y-auto"
              >
                <!-- GANTI DENGAN URL GAMBAR ANDA -->
                <img
                  src="assets\spdk_001.png"
                  alt="SPDK Halaman 1"
                  class="w-full h-auto border"
                />
                <img
                  src="assets\spdk_002.png"
                  alt="SPDK Halaman 2"
                  class="w-full h-auto border"
                />
                <img
                  src="assets\checklist_induksi.png"
                  alt="Checklist Induksi"
                  class="w-full h-auto border"
                />
              </div>
              <label class="mt-4 flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="spdk-agreement-checkbox"
                  class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"
                />
                <span class="ml-3 text-gray-700 font-medium"
                  >Saya telah membaca dan menyetujui dokumen di atas.</span
                >
              </label>
            </div>

            <!-- Tanda Tangan Section (Initially Hidden) -->
            <div id="signature-section" class="hidden mt-8">
              <h3 class="text-lg font-semibold text-gray-800 mb-2">
                2. Tanda Tangan
              </h3>
              <p class="text-gray-600 mb-4">
                Silakan lengkapi formulir dan berikan tanda tangan Anda. Tombol
                di bawah akan aktif setelah Anda menekan "Submit" pada formulir.
              </p>
              <iframe
                id="signature-frame"
                class="tally-embed"
                title="Formulir Tanda Tangan"
              ></iframe>
              <button
                id="continue-to-certificate-btn"
                class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
              >
                Lanjutkan ke Sertifikat
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="completion-screen"
        class="hidden bg-white p-8 rounded-xl shadow-md text-center mt-6 relative"
      ></div>

      <div class="text-center mt-8">
        <button
          id="reset-btn"
          class="text-sm text-gray-500 hover:text-gray-700 hover:underline"
        >
          Ulangi Proses dari Awal
        </button>
        <a
          href="index.html"
          class="mt-4 inline-block text-sm text-blue-600 hover:text-blue-800 hover:underline"
          >Kembali ke Halaman Utama</a
        >
      </div>
    </div>

    <!-- Hidden div for print message -->
    <div id="print-message" class="hidden">Tindakan ini tidak diizinkan.</div>

    <!-- Modal Konfirmasi -->
    <div
      id="confirmation-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg p-8 shadow-xl text-center max-w-sm">
        <p id="modal-text" class="text-lg font-medium mb-6"></p>
        <div class="flex justify-center space-x-4">
          <button
            id="modal-cancel"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg"
          >
            Batal
          </button>
          <button
            id="modal-confirm"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg"
          >
            Ya
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Admin Login -->
    <div
      id="admin-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-sm">
        <h3 class="text-lg font-bold text-center mb-4">Login Admin</h3>
        <form id="admin-login-form">
          <label
            for="admin-password"
            class="block text-sm font-medium text-gray-700"
            >Password</label
          >
          <input
            type="password"
            id="admin-password"
            name="admin-password"
            required
            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          />
          <p id="admin-error" class="text-red-500 text-sm mt-2 hidden">
            Password salah.
          </p>
          <div class="flex justify-end space-x-4 mt-6">
            <button
              type="button"
              id="admin-cancel-btn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg"
            >
              Batal
            </button>
            <button
              type="submit"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg"
            >
              Login
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Admin Quiz Settings -->
    <div
      id="admin-quiz-settings-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-md">
        <h3 class="text-lg font-bold text-center mb-6">
          Pengaturan Kuis Admin
        </h3>
        <form id="admin-quiz-settings-form" class="space-y-4">
          <!-- Jenis Tes -->
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Jenis Tes</label
            >
            <div class="mt-2 space-y-2">
              <label class="flex items-center">
                <input
                  type="radio"
                  name="adminTestType"
                  value="pre-test"
                  required
                  class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
                />
                <span class="ml-3 text-gray-700">Pre-Test</span>
              </label>
              <label class="flex items-center">
                <input
                  type="radio"
                  name="adminTestType"
                  value="post-test"
                  required
                  class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300"
                />
                <span class="ml-3 text-gray-700">Post-Test</span>
              </label>
            </div>
          </div>
          <!-- Jenis Induksi -->
          <div>
            <label
              for="admin-induction-type"
              class="block text-sm font-medium text-gray-700"
              >Jenis Induksi</label
            >
            <select
              id="admin-induction-type"
              name="admin-induction-type"
              required
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            >
              <!-- Options will be populated by JS -->
            </select>
          </div>
          <!-- Jabatan -->
          <div>
            <label
              for="admin-jabatan"
              class="block text-sm font-medium text-gray-700"
              >Jabatan</label
            >
            <select
              id="admin-jabatan"
              name="admin-jabatan"
              required
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            >
              <!-- Options will be populated by JS -->
            </select>
          </div>
          <!-- Buttons -->
          <div class="flex justify-end space-x-4 pt-4">
            <button
              type="button"
              id="admin-quiz-settings-cancel-btn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg"
            >
              Batal
            </button>
            <button
              type="submit"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg"
            >
              Mulai Kuis
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Kuis Modal -->
    <div
      id="quiz-modal"
      class="hidden fixed inset-0 bg-gray-100 z-40 p-4 overflow-y-auto"
    >
      <div
        class="w-full max-w-6xl mx-auto bg-white rounded-xl shadow-2xl my-8 flex h-[90vh]"
      >
        <!-- Main Content -->
        <div class="w-full p-8 relative overflow-y-auto">
          <div class="watermark"></div>
          <!-- Bagian Materi (Video) -->
          <div id="quiz-material-section" class="mb-6 pb-6 border-b">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h2
                  id="material-title"
                  class="text-xl font-bold text-gray-800"
                ></h2>
                <p id="material-progress" class="text-sm text-gray-500"></p>
              </div>
              <div class="flex items-center space-x-2">
                <div
                  id="quiz-timer"
                  class="text-lg font-bold text-gray-800 mr-4"
                ></div>
                <!-- Dropdown Navigasi Materi -->
                <div class="relative inline-block text-left">
                  <div>
                    <button
                      type="button"
                      id="quiz-nav-dropdown-btn"
                      class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none"
                    >
                      Daftar Materi
                      <svg
                        class="-mr-1 ml-2 h-5 w-5"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        aria-hidden="true"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </div>
                  <div
                    id="quiz-nav-list-container"
                    class="origin-top-right absolute right-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10"
                  >
                    <ul
                      id="quiz-nav-list"
                      class="py-1"
                      role="menu"
                      aria-orientation="vertical"
                      aria-labelledby="options-menu"
                    >
                      <!-- Populated by JS -->
                    </ul>
                  </div>
                </div>
                <button
                  id="open-video-btn"
                  class="bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-blue-200 transition"
                >
                  Buka Video
                </button>
                <button
                  id="back-to-steps-btn"
                  class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 transition"
                >
                  Kembali ke Langkah
                </button>
              </div>
            </div>
            <div
              id="video-container"
              class="aspect-video bg-black rounded-lg mb-4"
            ></div>
            <div class="flex items-center justify-between">
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="video-watched-checkbox"
                  class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"
                />
                <span class="ml-3 text-gray-700 font-medium text-sm"
                  >Saya telah menonton dan memahami materi video.</span
                >
              </label>
              <button
                id="replay-video-btn"
                class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-300 transition"
              >
                Putar Ulang
              </button>
            </div>
          </div>

          <!-- Bagian Pertanyaan (Awalnya Tersembunyi) -->
          <div id="quiz-question-section" class="hidden">
            <div class="flex justify-between mb-1">
              <span
                id="progress-text"
                class="text-base font-medium text-blue-700"
              ></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
              <div
                id="progress-bar"
                class="bg-blue-600 h-2.5 rounded-full"
                style="width: 0%"
              ></div>
            </div>
            <div id="quiz-container"></div>
          </div>

          <!-- Tombol Navigasi -->
          <div
            id="navigation-buttons"
            class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center"
          >
            <button
              id="prev-button"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Sebelumnya
            </button>
            <button
              id="next-button"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Selanjutnya
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Fullscreen Loader -->
    <div
      id="fullscreen-loader"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-[100]"
    >
      <div class="spinner"></div>
      <p id="loader-text" class="text-white text-lg mt-4 font-semibold">
        Memuat...
      </p>
    </div>

    <script>
      // --- KONFIGURASI WAJIB ---
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbyEzbJT_-0i3_4mx4fDAo4R0MFWPYNHrAGTguaYkZorQ8tfoZYi0hukvFqSeC2ayg/exec";
      const TALLY_SIGNATURE_URL = "https://tally.so/embed/wMp27Y";
      const PASSING_SCORE = 70; // Nilai Kelulusan Minimal (contoh: 75)
      const ADMIN_PASSWORD = "gamhse2024"; // Password untuk mode admin
      // -------------------------

      // Inisialisasi jsPDF
      const { jsPDF } = window.jspdf;

      const dom = {
        appContainer: document.getElementById("app-container"),
        onlineStatus: document.getElementById("online-status"),
        completionScreen: document.getElementById("completion-screen"),
        allSteps: document.querySelectorAll(".step-card"),
        resetButton: document.getElementById("reset-btn"),
        userInfoForm: document.getElementById("user-info-form"),
        absensiBtn: document.getElementById("start-absensi-btn"),
        inductionTypeSelect: document.getElementById("induction-type"),
        selectInductionBtn: document.getElementById("select-induction-btn"),
        guideCheckbox: document.getElementById("guide-checkbox"),
        startProcessBtn: document.getElementById("start-process-btn"),
        confirmTestTypeBtn: document.getElementById("confirm-test-type-btn"),
        startGeneralQuizBtn: document.getElementById("start-general-quiz-btn"),
        startSpecificQuizBtn: document.getElementById(
          "start-specific-quiz-btn"
        ),
        spdkAgreementCheckbox: document.getElementById(
          "spdk-agreement-checkbox"
        ),
        signatureSection: document.getElementById("signature-section"),
        continueToCertificateBtn: document.getElementById(
          "continue-to-certificate-btn"
        ),
        signatureFrame: document.getElementById("signature-frame"),
        loader: {
          container: document.getElementById("fullscreen-loader"),
          text: document.getElementById("loader-text"),
        },
        quiz: {
          modal: document.getElementById("quiz-modal"),
          navDropdownBtn: document.getElementById("quiz-nav-dropdown-btn"),
          navListContainer: document.getElementById("quiz-nav-list-container"),
          navList: document.getElementById("quiz-nav-list"),
          backToStepsBtn: document.getElementById("back-to-steps-btn"),
          materialSection: document.getElementById("quiz-material-section"),
          materialTitle: document.getElementById("material-title"),
          materialProgress: document.getElementById("material-progress"),
          videoContainer: document.getElementById("video-container"),
          videoWatchedCheckbox: document.getElementById(
            "video-watched-checkbox"
          ),
          replayVideoBtn: document.getElementById("replay-video-btn"),
          openVideoBtn: document.getElementById("open-video-btn"),
          questionSection: document.getElementById("quiz-question-section"),
          progressText: document.getElementById("progress-text"),
          progressBar: document.getElementById("progress-bar"),
          container: document.getElementById("quiz-container"),
          nextBtn: document.getElementById("next-button"),
          prevBtn: document.getElementById("prev-button"),
          timer: document.getElementById("quiz-timer"),
        },
        modal: {
          container: document.getElementById("confirmation-modal"),
          text: document.getElementById("modal-text"),
          confirmBtn: document.getElementById("modal-confirm"),
          cancelBtn: document.getElementById("modal-cancel"),
        },
        admin: {
          loginBtn: document.getElementById("admin-login-btn"),
          modal: document.getElementById("admin-modal"),
          form: document.getElementById("admin-login-form"),
          passwordInput: document.getElementById("admin-password"),
          errorMsg: document.getElementById("admin-error"),
          cancelBtn: document.getElementById("admin-cancel-btn"),
          quizSettingsModal: document.getElementById(
            "admin-quiz-settings-modal"
          ),
          quizSettingsForm: document.getElementById("admin-quiz-settings-form"),
          quizSettingsCancelBtn: document.getElementById(
            "admin-quiz-settings-cancel-btn"
          ),
        },
      };

      let state = {
        currentStep: 0,
        isOnline: navigator.onLine,
        isAdminMode: false,
        userData: {},
        remedialCount: 0,
        quizData: {
          allAnswers: {},
          allQuestions: [],
          currentMaterials: [],
          currentTotalQuestions: 0,
          finalScore: 0,
          currentQuizType: "",
        },
      };

      const inductionTypeMap = {
        induksi_visitor: "Induksi Visitor",
        karyawan_baru: "Karyawan Baru Mitra / PT.GAM",
        pasca_cuti_mitra: "Pasca Cuti Mitra",
        pasca_cuti_gam: "Pasca Cuti PT.GAM",
        temporary: "Temporary",
        magang: "Magang",
      };

      function initApp() {
        loadState();
        loadCachedUserInfo();
        checkOnlineStatus();
        addEventListeners();
        updateUI();
      }

      function updateUI() {
        const isAdmin = state.isAdminMode;

        dom.allSteps.forEach((step, index) => {
          const content = step.querySelector(".step-content");
          const statusEl = document.getElementById(`step-${index}-status`);

          if (isAdmin) {
            step.classList.remove("locked");
            if (statusEl) {
              statusEl.textContent = "Admin Access";
              statusEl.className = "text-sm font-semibold text-purple-500";
            }
            content.classList.remove("open");
          } else {
            // Normal user logic
            if (index < state.currentStep) {
              step.classList.remove("locked");
              if (statusEl) {
                statusEl.textContent = "Selesai";
                statusEl.className = "text-sm font-semibold text-green-500";
              }
              content.classList.remove("open");
            } else if (index === state.currentStep) {
              step.classList.remove("locked");
              if (statusEl) {
                statusEl.textContent = "Berlangsung";
                statusEl.className = "text-sm font-semibold text-blue-500";
              }
              content.classList.add("open");
            } else {
              step.classList.add("locked");
              content.classList.remove("open");
              if (statusEl) {
                statusEl.textContent = "Terkunci";
                statusEl.className = "text-sm font-semibold text-red-500";
              }
            }
          }
        });

        for (const key in state.userData) {
          const el = dom.userInfoForm.elements[key];
          if (el && key !== "perusahaan") {
            if (el.type === "radio") {
              const radioToCheck = document.querySelector(
                `input[name="${key}"][value="${state.userData[key]}"]`
              );
              if (radioToCheck) radioToCheck.checked = true;
            } else {
              el.value = state.userData[key];
            }
          }
        }

        if (state.userData.perusahaan) {
          const perusahaanSelect =
            dom.userInfoForm.elements["perusahaan-select"];
          const perusahaanLainnyaInput =
            dom.userInfoForm.elements["perusahaan-lainnya"];
          const perusahaanLainnyaContainer = document.getElementById(
            "perusahaan-lainnya-container"
          );

          const isStandardCompany = [...perusahaanSelect.options].some(
            (opt) => opt.value === state.userData.perusahaan
          );

          if (isStandardCompany) {
            perusahaanSelect.value = state.userData.perusahaan;
            perusahaanLainnyaContainer.classList.add("hidden");
            perusahaanLainnyaInput.required = false;
          } else {
            perusahaanSelect.value = "Lainnya";
            perusahaanLainnyaContainer.classList.remove("hidden");
            perusahaanLainnyaInput.value = state.userData.perusahaan;
            perusahaanLainnyaInput.required = true;
          }
        }

        if (state.userData.inductionType)
          dom.inductionTypeSelect.value = state.userData.inductionType;

        // Pastikan form Tally dimuat jika pengguna berada di atau setelah Langkah 7
        if (state.currentStep >= 7 || isAdmin) {
          loadTallyForms();
        }
      }

      function saveState() {
        localStorage.setItem("inductionAppState", JSON.stringify(state));
      }

      function loadState() {
        const savedState = localStorage.getItem("inductionAppState");
        if (savedState) {
          try {
            const parsedState = JSON.parse(savedState);
            // Ensure remedialCount exists, default to 0 if not
            state = {
              ...parsedState,
              remedialCount: parsedState.remedialCount || 0,
            };
          } catch (error) {
            console.error(
              "Gagal memuat state dari localStorage, mereset state:",
              error
            );
            localStorage.removeItem("inductionAppState");
          }
        }
      }

      function resetState() {
        showModal(
          "Apakah Anda yakin ingin memulai sesi baru? Progres saat ini akan hilang.",
          () => {
            localStorage.removeItem("inductionAppState");
            localStorage.removeItem("offlineQueue");
            location.reload();
          },
          "Ya, Mulai Baru"
        );
      }

      function advanceStep(step) {
        state.currentStep = step;
        if (step === 7) {
          loadTallyForms();
        }
        saveState();
        updateUI();
      }

      function addEventListeners() {
        window.addEventListener("online", checkOnlineStatus);
        window.addEventListener("offline", checkOnlineStatus);
        dom.resetButton.addEventListener("click", resetState);

        document.querySelectorAll(".step-header").forEach((header) => {
          header.addEventListener("click", () => {
            if (!header.parentElement.classList.contains("locked")) {
              const currentOpenStep =
                document.querySelector(".step-content.open");
              if (
                currentOpenStep &&
                currentOpenStep !== header.nextElementSibling
              ) {
                currentOpenStep.classList.remove("open");
              }
              header.nextElementSibling.classList.toggle("open");

              if (state.isAdminMode && header.parentElement.id === "step-7") {
                loadTallyForms();
              }
            }
          });
        });

        dom.guideCheckbox.addEventListener("change", () => {
          dom.startProcessBtn.disabled = !dom.guideCheckbox.checked;
        });
        dom.startProcessBtn.addEventListener("click", () => advanceStep(1));

        dom.userInfoForm.addEventListener("submit", handleUserInfoSubmit);
        dom.absensiBtn.addEventListener("click", handleAbsensi);
        dom.selectInductionBtn.addEventListener("click", handleSelectInduction);
        dom.confirmTestTypeBtn.addEventListener("click", handleConfirmTestType);
        dom.startGeneralQuizBtn.addEventListener("click", (e) =>
          handleStartQuiz(e, "general")
        );
        dom.startSpecificQuizBtn.addEventListener("click", (e) =>
          handleStartQuiz(e, "specific")
        );

        dom.spdkAgreementCheckbox.addEventListener("change", (e) => {
          dom.signatureSection.classList.toggle("hidden", !e.target.checked);
          if (e.target.checked) {
            loadTallyForms();
          }
        });

        dom.continueToCertificateBtn.addEventListener("click", () =>
          showCertificateScreen()
        );

        const perusahaanSelect = document.getElementById("perusahaan-select");
        const perusahaanLainnyaContainer = document.getElementById(
          "perusahaan-lainnya-container"
        );
        const perusahaanLainnyaInput =
          document.getElementById("perusahaan-lainnya");

        perusahaanSelect.addEventListener("change", (e) => {
          if (e.target.value === "Lainnya") {
            perusahaanLainnyaContainer.classList.remove("hidden");
            perusahaanLainnyaInput.required = true;
          } else {
            perusahaanLainnyaContainer.classList.add("hidden");
            perusahaanLainnyaInput.required = false;
            perusahaanLainnyaInput.value = "";
          }
        });

        // Admin Login Listeners
        dom.admin.loginBtn.addEventListener("click", () => {
          dom.admin.modal.classList.remove("hidden");
          dom.admin.passwordInput.focus();
        });
        dom.admin.cancelBtn.addEventListener("click", () => {
          dom.admin.modal.classList.add("hidden");
          dom.admin.form.reset();
          dom.admin.errorMsg.classList.add("hidden");
        });
        dom.admin.form.addEventListener("submit", (e) => {
          e.preventDefault();
          const password = dom.admin.passwordInput.value;
          if (password === ADMIN_PASSWORD) {
            state.isAdminMode = true;
            dom.admin.modal.classList.add("hidden");
            dom.admin.form.reset();
            dom.admin.errorMsg.classList.add("hidden");
            updateUI();
          } else {
            dom.admin.errorMsg.classList.add("hidden");
          }
        });

        // Admin Quiz Settings Listeners
        dom.admin.quizSettingsCancelBtn.addEventListener("click", () => {
          dom.admin.quizSettingsModal.classList.add("hidden");
        });
        dom.admin.quizSettingsForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const settings = Object.fromEntries(formData.entries());

          // Temporarily override user data for the quiz
          state.userData.testType = settings.adminTestType;
          state.userData.inductionType = settings["admin-induction-type"];
          state.userData.jabatan = settings["admin-jabatan"];

          dom.admin.quizSettingsModal.classList.add("hidden");

          // Fetch and launch the quiz with the selected settings
          const quizType = state.quizData.currentQuizType; // Get the quiz type that was clicked
          fetchAndLaunchQuiz(quizType);
        });

        // Quiz Modal Back Button
        dom.quiz.backToStepsBtn.addEventListener("click", () => {
          dom.quiz.modal.classList.add("hidden");
        });

        // Quiz Nav Dropdown
        dom.quiz.navDropdownBtn.addEventListener("click", () => {
          dom.quiz.navListContainer.classList.toggle("hidden");
        });
        // Close dropdown when clicking outside
        window.addEventListener("click", function (e) {
          if (
            !dom.quiz.navDropdownBtn.contains(e.target) &&
            !dom.quiz.navListContainer.contains(e.target)
          ) {
            dom.quiz.navListContainer.classList.add("hidden");
          }
        });

        // Listen for Tally form submission
        window.addEventListener("message", (event) => {
          if (event.origin === "https://tally.so") {
            // try {
            //   const data = JSON.parse(event.data);
            //   if (data && data.event === "Tally.formSubmitted") {
            //     dom.continueToCertificateBtn.disabled = false;
            //     showAlert("Formulir berhasil disubmit. Silakan lanjutkan.");
            //   }
            // } catch (e) {
            //   // Do nothing if data is not valid JSON
            // }
          }
        });
      }

      async function getIpAddress() {
        try {
          const response = await fetch("https://api.ipify.org?format=json");
          if (!response.ok) return "Gagal mendapatkan IP";
          const data = await response.json();
          return data.ip;
        } catch (error) {
          console.error("Gagal mengambil IP address:", error);
          return "Tidak tersedia";
        }
      }

      async function handleUserInfoSubmit(e) {
        e.preventDefault();
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showLoader("Menyimpan data peserta...");

        try {
          const formData = new FormData(e.target);
          state.userData = Object.fromEntries(formData.entries());

          const perusahaanPilihan = formData.get("perusahaan-select");
          if (perusahaanPilihan === "Lainnya") {
            state.userData.perusahaan = formData.get("perusahaan-lainnya");
          } else {
            state.userData.perusahaan = perusahaanPilihan;
          }
          delete state.userData["perusahaan-select"];
          delete state.userData["perusahaan-lainnya"];

          state.userData.timestamp = new Date().toISOString();
          state.userData.ip_address = await getIpAddress();

          const userInfoToCache = {
            nik: state.userData.nik,
            nama: state.userData.nama,
            email: state.userData.email,
            whatsapp: state.userData.whatsapp,
            perusahaan: state.userData.perusahaan,
            jabatan: state.userData.jabatan,
          };
          localStorage.setItem(
            "cachedUserInfo",
            JSON.stringify(userInfoToCache)
          );

          await postDataWithOfflineQueue({
            action: "saveUser",
            payload: state.userData,
          });
          await postDataWithOfflineQueue({
            action: "saveDataDiri",
            payload: state.userData,
          });

          advanceStep(2);
        } catch (error) {
          console.error("Gagal menyimpan data diri:", error);
          showAlert(`Terjadi kesalahan: ${error.message}`);
        } finally {
          hideLoader();
          submitButton.disabled = false;
        }
      }

      function handleAbsensi(e) {
        const button = e.target;
        showModal(
          "Konfirmasi untuk melakukan absensi?",
          async () => {
            button.disabled = true;
            showLoader("Mencatat absensi...");
            try {
              await postDataWithOfflineQueue({
                action: "saveAbsensi",
                payload: state.userData,
              });
              advanceStep(3);
            } catch (error) {
              console.error("Gagal mencatat absensi:", error);
              showAlert(`Terjadi kesalahan: ${error.message}`);
            } finally {
              hideLoader();
              button.disabled = false;
            }
          },
          "Ya, Absen"
        );
      }

      function handleSelectInduction() {
        const type = dom.inductionTypeSelect.value;
        if (!type) {
          showAlert("Silakan pilih tipe induksi.");
          return;
        }
        state.userData.inductionType = type;
        advanceStep(4); // Lanjut ke pilih jenis tes
      }

      function handleConfirmTestType() {
        const testTypeRadio = document.querySelector(
          'input[name="testType"]:checked'
        );
        if (!testTypeRadio) {
          showAlert("Silakan pilih jenis tes terlebih dahulu.");
          return;
        }
        state.userData.testType = testTypeRadio.value;

        const type = state.userData.inductionType;
        if (type === "induksi_visitor" || type === "temporary") {
          advanceStep(6); // Lanjut ke kuis spesifik
        } else {
          advanceStep(5); // Lanjut ke kuis umum
        }
      }

      function populateAdminQuizSettingsModal() {
        const inductionSelect = document.getElementById("admin-induction-type");
        const jabatanSelect = document.getElementById("admin-jabatan");

        // Clear existing options
        inductionSelect.innerHTML = "";
        jabatanSelect.innerHTML = "";

        // Populate Jenis Induksi
        const originalInductionSelect =
          document.getElementById("induction-type");
        originalInductionSelect.querySelectorAll("option").forEach((opt) => {
          if (opt.value) {
            // Skip the disabled "Pilih Tipe Induksi"
            inductionSelect.add(opt.cloneNode(true));
          }
        });
        // Add "Umum" for Kuis Umum
        const umumOption = document.createElement("option");
        umumOption.value = "umum";
        umumOption.textContent = "Induksi Umum";
        inductionSelect.add(umumOption);

        // Populate Jabatan
        const originalJabatanSelect = document.getElementById("jabatan");
        originalJabatanSelect.querySelectorAll("option").forEach((opt) => {
          if (opt.value) {
            // Skip the disabled "Pilih Jabatan Anda"
            jabatanSelect.add(opt.cloneNode(true));
          }
        });
        // Add "All" for general cases
        const allOption = document.createElement("option");
        allOption.value = "all";
        allOption.textContent = "Semua Jabatan";
        jabatanSelect.add(allOption);
      }

      function handleStartQuiz(e, quizType) {
        state.quizData.currentQuizType = quizType; // Store which button was clicked
        if (state.isAdminMode) {
          populateAdminQuizSettingsModal();
          dom.admin.quizSettingsModal.classList.remove("hidden");
        } else {
          fetchAndLaunchQuiz(quizType);
        }
      }

      async function fetchAndLaunchQuiz(quizType) {
        showLoader("Memuat soal kuis...");

        const errorElId = `${quizType}-quiz-error`;
        const errorEl = document.getElementById(errorElId);
        if (errorEl) errorEl.classList.add("hidden");

        if (quizType === "general") {
          state.quizData.allAnswers = {};
          state.quizData.allQuestions = [];
        }

        try {
          let payload;
          if (quizType === "general") {
            payload = { tipe_induksi: "umum", jabatan_id: "all" };
          } else {
            const inductionType = state.userData.inductionType;
            let jabatanId = state.userData.jabatan;

            if (
              inductionType === "temporary" ||
              inductionType === "induksi_visitor"
            ) {
              jabatanId = "all";
            }

            payload = {
              tipe_induksi: inductionType,
              jabatan_id: jabatanId,
            };
          }

          const materials = await postDataWithOfflineQueue({
            action: "getSoal",
            payload: payload,
          });

          if (!materials || materials.length === 0)
            throw new Error(
              "Tidak ada materi/soal yang ditemukan untuk kuis ini."
            );

          let currentTotalQuestions = 0;
          materials.forEach((m) => {
            if (m.questions && Array.isArray(m.questions)) {
              currentTotalQuestions += m.questions.length;
              state.quizData.allQuestions.push(...m.questions);
            }
          });

          if (currentTotalQuestions === 0)
            throw new Error(
              "Materi ditemukan, tetapi tidak ada soal di dalamnya."
            );

          state.quizData.currentMaterials = materials;
          state.quizData.currentTotalQuestions = currentTotalQuestions;

          saveState();
          launchQuizModal();
        } catch (error) {
          console.error(`Gagal memuat ${quizType} kuis:`, error);
          if (errorEl) {
            errorEl.textContent = `Gagal memuat soal. Pesan dari server: ${error.message}`;
            errorEl.classList.remove("hidden");
          }
        } finally {
          hideLoader();
        }
      }

      // --- MODAL AND LOADER FUNCTIONS ---

      function showAlert(text, onOk = () => {}) {
        showModal(text, onOk, "OK", null);
      }

      function showModal(
        text,
        onConfirm,
        confirmText = "Ya",
        onCancel = () => {},
        cancelText = "Batal"
      ) {
        dom.modal.text.textContent = text;
        dom.modal.confirmBtn.textContent = confirmText;

        if (onCancel) {
          dom.modal.cancelBtn.textContent = cancelText;
          dom.modal.cancelBtn.style.display = "inline-block";
        } else {
          dom.modal.cancelBtn.style.display = "none";
        }

        dom.modal.container.classList.remove("hidden");

        const confirmHandler = () => {
          onConfirm();
          hideModal();
          cleanup();
        };
        const cancelHandler = () => {
          if (onCancel) onCancel();
          hideModal();
          cleanup();
        };
        const cleanup = () => {
          dom.modal.confirmBtn.removeEventListener("click", confirmHandler);
          if (onCancel) {
            dom.modal.cancelBtn.removeEventListener("click", cancelHandler);
          }
        };

        dom.modal.confirmBtn.addEventListener("click", confirmHandler);
        if (onCancel) {
          dom.modal.cancelBtn.addEventListener("click", cancelHandler);
        }
      }

      function hideModal() {
        dom.modal.container.classList.add("hidden");
      }

      function showLoader(message = "Memuat...") {
        dom.loader.text.textContent = message;
        dom.loader.container.classList.remove("hidden");
      }

      function hideLoader() {
        dom.loader.container.classList.add("hidden");
      }

      // --- QUIZ LOGIC ---

      function launchQuizModal() {
        state.quizData.currentMaterialIndex = 0;
        state.quizData.currentQuestionIndex = 0;
        dom.quiz.modal.classList.remove("hidden");
        dom.quiz.nextBtn.onclick = handleQuizNext;
        dom.quiz.prevBtn.onclick = handleQuizPrev;
        populateQuizNavigation();
        populateQuizWatermark();
        displayCurrentMaterial();
      }

      function populateQuizNavigation() {
        const { currentMaterials } = state.quizData;
        dom.quiz.navList.innerHTML = ""; // Clear previous list

        currentMaterials.forEach((material, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
                <button data-index="${index}" class="nav-item block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">
                    ${index + 1}. ${material.materi_judul}
                </button>
            `;
          dom.quiz.navList.appendChild(li);
        });

        dom.quiz.navList.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            const index = parseInt(e.currentTarget.dataset.index, 10);
            state.quizData.currentMaterialIndex = index;
            state.quizData.currentQuestionIndex = 0;
            displayCurrentMaterial();
            dom.quiz.navListContainer.classList.add("hidden"); // Close dropdown after selection
          });
        });
      }

      function updateQuizNavigation() {
        const { currentMaterialIndex } = state.quizData;
        dom.quiz.navList
          .querySelectorAll(".nav-item")
          .forEach((item, index) => {
            item.classList.toggle(
              "bg-indigo-50",
              index === currentMaterialIndex
            );
            item.classList.toggle(
              "text-indigo-700",
              index === currentMaterialIndex
            );
            item.classList.toggle(
              "font-semibold",
              index === currentMaterialIndex
            );
          });
      }

      function populateQuizWatermark() {
        const watermarkContainer = dom.quiz.modal.querySelector(".watermark");
        if (!watermarkContainer) return;
        watermarkContainer.innerHTML = "";
        const watermarkText = `${state.userData.nama || "Admin"} - ${
          state.userData.perusahaan || "PT. GAM"
        }`;
        for (let i = 0; i < 15; i++) {
          // Mengurangi jumlah watermark
          const item = document.createElement("div");
          item.className = "watermark-item";
          item.textContent = watermarkText;
          watermarkContainer.appendChild(item);
        }
      }

      function displayCurrentMaterial() {
        const { currentMaterials, currentMaterialIndex } = state.quizData;
        const material = currentMaterials[currentMaterialIndex];

        dom.quiz.materialSection.classList.toggle(
          "hidden",
          state.userData.testType === "pre-test"
        );
        dom.quiz.questionSection.classList.toggle(
          "hidden",
          state.userData.testType !== "pre-test"
        );

        if (state.userData.testType === "pre-test") {
          displayCurrentQuestion();
        } else {
          dom.quiz.videoWatchedCheckbox.checked = false;
          dom.quiz.videoWatchedCheckbox.disabled = false;
          dom.quiz.materialTitle.textContent = material.materi_judul;
          dom.quiz.materialProgress.textContent = `Materi ${
            currentMaterialIndex + 1
          } dari ${currentMaterials.length}`;
          loadVideo(material.video_url);
          dom.quiz.openVideoBtn.onclick = () =>
            window.open(material.video_url, "_blank");
          dom.quiz.replayVideoBtn.onclick = () => loadVideo(material.video_url);
          dom.quiz.videoWatchedCheckbox.onchange = (e) => {
            if (e.target.checked) {
              dom.quiz.questionSection.classList.remove("hidden");
              e.target.disabled = true;
              displayCurrentQuestion();
            }
          };
        }
        updateQuizNavigation();
        updateNavigationButtons();
      }

      function loadVideo(videoUrl) {
        if (videoUrl && videoUrl.trim() !== "") {
          const videoId =
            videoUrl.split("v=")[1]?.split("&")[0] || videoUrl.split("/").pop();
          dom.quiz.videoContainer.innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        } else {
          dom.quiz.videoContainer.innerHTML = `<div class="w-full h-full bg-gray-200 flex items-center justify-center"><p class="text-gray-500">Tidak ada video untuk materi ini.</p></div>`;
          dom.quiz.videoWatchedCheckbox.checked = true;
          dom.quiz.videoWatchedCheckbox.dispatchEvent(new Event("change"));
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function displayCurrentQuestion() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const material = currentMaterials[currentMaterialIndex];
        const q = material.questions[currentQuestionIndex];

        let options = [
          q.pilihan_a,
          q.pilihan_b,
          q.pilihan_c,
          q.pilihan_d,
        ].filter((opt) => opt && String(opt).trim() !== "");
        options = shuffleArray(options);

        let imageHtml = "";
        if (q.gambar && q.gambar.trim() !== "") {
          imageHtml = `<img src="${q.gambar}" alt="Gambar Soal" class="my-4 rounded-lg max-w-full h-auto mx-auto border">`;
        }

        dom.quiz.container.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">
            <span class="font-bold">Pertanyaan ${
              currentQuestionIndex + 1
            } dari ${material.questions.length}:</span>
          </h2>
          <p class="text-lg mb-4">${q.pertanyaan}</p>
          ${imageHtml}
          <div class="space-y-4">
            ${options
              .map(
                (option, i) => `
                <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition-all">
                    <input type="radio" name="question${q.id_soal}" value="${option}" class="h-5 w-5 text-blue-600">
                    <span class="ml-4 text-sm">${option}</span>
                </label>
            `
              )
              .join("")}
          </div>`;

        const savedAnswer = state.quizData.allAnswers[q.id_soal];
        if (savedAnswer) {
          const radio = dom.quiz.container.querySelector(
            `input[value="${savedAnswer}"]`
          );
          if (radio) radio.checked = true;
        }

        updateQuizProgress();
        updateNavigationButtons();
      }

      function updateQuizProgress() {
        const totalQuestions = state.quizData.currentTotalQuestions;
        let questionNumber = 1;
        for (let i = 0; i < state.quizData.currentMaterialIndex; i++) {
          questionNumber += state.quizData.currentMaterials[i].questions.length;
        }
        questionNumber += state.quizData.currentQuestionIndex;

        const progress =
          totalQuestions > 0 ? (questionNumber / totalQuestions) * 100 : 0;
        dom.quiz.progressBar.style.width = `${progress}%`;
        dom.quiz.progressText.textContent = `Soal ${questionNumber} dari ${totalQuestions}`;
      }

      function updateNavigationButtons() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const isFirstQuestionOverall =
          currentMaterialIndex === 0 && currentQuestionIndex === 0;
        dom.quiz.prevBtn.disabled = isFirstQuestionOverall;

        const isLastQuestionOverall =
          currentMaterialIndex === currentMaterials.length - 1 &&
          currentQuestionIndex ===
            currentMaterials[currentMaterialIndex].questions.length - 1;
        dom.quiz.nextBtn.textContent = isLastQuestionOverall
          ? "Selesai"
          : "Selanjutnya";
      }

      function handleQuizNext() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const currentQuestion =
          currentMaterials[currentMaterialIndex].questions[
            currentQuestionIndex
          ];
        const selectedOption = document.querySelector(
          `input[name="question${currentQuestion.id_soal}"]:checked`
        );

        if (
          state.userData.testType !== "pre-test" &&
          !dom.quiz.videoWatchedCheckbox.checked
        ) {
          showAlert(
            "Harap tonton video dan centang kotak konfirmasi terlebih dahulu."
          );
          return;
        }

        if (!selectedOption) {
          showAlert("Harap pilih satu jawaban untuk melanjutkan.");
          return;
        }
        state.quizData.allAnswers[currentQuestion.id_soal] =
          selectedOption.value;

        const isLastQuestionInMaterial =
          currentQuestionIndex ===
          currentMaterials[currentMaterialIndex].questions.length - 1;

        if (!isLastQuestionInMaterial) {
          state.quizData.currentQuestionIndex++;
          displayCurrentQuestion();
        } else {
          const isLastMaterial =
            currentMaterialIndex === currentMaterials.length - 1;
          if (!isLastMaterial) {
            state.quizData.currentMaterialIndex++;
            state.quizData.currentQuestionIndex = 0;
            displayCurrentMaterial();
          } else {
            finishQuiz();
          }
        }
        saveState();
      }

      function handleQuizPrev() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const isFirstQuestionInMaterial = currentQuestionIndex === 0;

        if (!isFirstQuestionInMaterial) {
          state.quizData.currentQuestionIndex--;
          displayCurrentQuestion();
        } else {
          const isFirstMaterial = currentMaterialIndex === 0;
          if (!isFirstMaterial) {
            state.quizData.currentMaterialIndex--;
            const prevMaterial =
              state.quizData.currentMaterials[
                state.quizData.currentMaterialIndex
              ];
            state.quizData.currentQuestionIndex =
              prevMaterial.questions.length - 1;
            displayCurrentMaterial();
          }
        }
        saveState();
      }

      async function finishQuiz() {
        dom.quiz.modal.classList.add("hidden");
        calculateFinalScore();

        if (state.isAdminMode) {
          showAlert(
            `Kuis Admin Selesai. Skor: ${state.quizData.finalScore.toFixed(2)}`
          );
          // Reset temporary data
          delete state.userData.testType;
          delete state.userData.inductionType;
          delete state.userData.jabatan;
          return;
        }

        if (state.quizData.currentQuizType === "general") {
          advanceStep(6);
        } else {
          showLoader("Menyimpan hasil akhir...");
          try {
            const payload = {
              ...state.userData,
              skor: state.quizData.finalScore,
              tipe_induksi: state.userData.inductionType,
              detail_jawaban: JSON.stringify(state.quizData.allAnswers),
            };
            await postDataWithOfflineQueue({
              action: "saveJawaban",
              payload: payload,
            });

            if (state.userData.testType === "pre-test") {
              // For pre-test, just show the final screen. Do not advance to the TTD step.
              showFinalScreen();
            } else if (state.quizData.finalScore < PASSING_SCORE) {
              showFinalScreen();
            } else {
              advanceStep(7);
            }
          } catch (error) {
            console.error("Gagal menyimpan jawaban:", error);
            showAlert(`Gagal menyimpan jawaban: ${error.message}`);
          } finally {
            hideLoader();
          }
        }
      }

      function calculateFinalScore() {
        let correctAnswers = 0;
        const totalQuestions = state.quizData.allQuestions.length;

        if (totalQuestions === 0) {
          state.quizData.finalScore = 0;
          return;
        }

        state.quizData.allQuestions.forEach((q) => {
          const userAnswer = state.quizData.allAnswers[q.id_soal];
          const correctAnswer = q.kunci_jawaban;

          if (
            userAnswer &&
            correctAnswer &&
            String(userAnswer).trim() === String(correctAnswer).trim()
          ) {
            correctAnswers++;
          }
        });

        state.quizData.finalScore = (correctAnswers / totalQuestions) * 100;
      }

      // --- COMPLETION & CERTIFICATE ---

      function triggerConfetti() {
        const container = document.createElement("div");
        container.className = "confetti-container";
        dom.completionScreen.appendChild(container);
        const colors = [
          "#f44336",
          "#e91e63",
          "#9c27b0",
          "#673ab7",
          "#3f51b5",
          "#2196f3",
          "#03a9f4",
          "#00bcd4",
          "#009688",
          "#4caf50",
          "#8bc34a",
          "#cddc39",
          "#ffeb3b",
          "#ffc107",
          "#ff9800",
        ];
        for (let i = 0; i < 100; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.top = Math.random() * -100 + "vh";
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 2 + "s";
          container.appendChild(confetti);
        }
        setTimeout(() => container.remove(), 6000);
      }

      function showFinalScreen() {
        dom.appContainer.classList.add("hidden");
        dom.completionScreen.classList.remove("hidden");
        let content = "";

        if (state.userData.testType === "pre-test") {
          content = `<h2 class="text-2xl font-bold text-indigo-600">Pre-Test Selesai!</h2>
                      <p class="mt-4 text-gray-700">Skor Akhir Anda: <strong>${state.quizData.finalScore.toFixed(
                        2
                      )}</strong></p>
                      <p class="mt-2 text-gray-600">Data Anda telah berhasil disimpan. Sekarang, silakan mengikuti sesi induksi tatap muka. Setelah itu, kembali lagi untuk mengerjakan Post-Test.</p>
                      <button onclick="location.reload()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Selesaikan Sesi</button>`;
          localStorage.removeItem("inductionAppState");
        } else if (state.quizData.finalScore < PASSING_SCORE) {
          let remedialWarning = "";
          if (state.remedialCount >= 2) {
            remedialWarning = `<div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 text-yellow-800 text-sm rounded-lg">
                  <strong>Peringatan:</strong> Anda telah gagal 3 kali. Jika remidi berikutnya masih gagal, Anda diwajibkan menghubungi PIC untuk induksi tatap muka via Zoom dengan tim HSE PT. GAM.
              </div>`;
          }

          content = `<h2 class="text-2xl font-bold text-red-600">Mohon Maaf, Anda Belum Lulus</h2>
                      <p class="mt-4 text-gray-700">Skor Akhir Anda adalah <strong>${state.quizData.finalScore.toFixed(
                        2
                      )}</strong>, sedangkan nilai kelulusan minimal adalah <strong>${PASSING_SCORE}</strong>.</p>
                      <p class="mt-2 text-gray-600">Silakan pilih salah satu opsi di bawah ini.</p>
                      <button id="remedial-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Jawab Ulang (Remidi)</button>
                      ${remedialWarning}
                      <button id="continue-anyway-btn" class="mt-4 text-sm text-gray-500 hover:underline">Tetap Lanjutkan dengan persetujuan pengawas</button>
                      `;
        } else {
          advanceStep(7);
          return;
        }

        dom.completionScreen.innerHTML = content;

        const continueButton = document.getElementById("continue-anyway-btn");
        if (continueButton) {
          continueButton.addEventListener("click", () => {
            dom.completionScreen.classList.add("hidden");
            dom.appContainer.classList.remove("hidden");
            advanceStep(7);
          });
        }

        const remedialButton = document.getElementById("remedial-btn");
        if (remedialButton) {
          remedialButton.addEventListener("click", () => {
            state.remedialCount++;
            state.quizData.allAnswers = {};
            state.quizData.allQuestions = [];
            saveState();

            dom.completionScreen.classList.add("hidden");
            dom.appContainer.classList.remove("hidden");

            const type = state.userData.inductionType;
            if (type === "induksi_visitor" || type === "temporary") {
              advanceStep(6);
            } else {
              advanceStep(5);
            }
          });
        }
      }

      function showCertificateScreen() {
        dom.appContainer.classList.add("hidden");
        dom.completionScreen.classList.remove("hidden");

        const date = new Date(state.userData.timestamp);
        const formattedTime = date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const inductionText =
          inductionTypeMap[state.userData.inductionType] ||
          state.userData.inductionType;

        const content = `<div class="border-4 border-green-500 rounded-lg p-6 bg-green-50 text-left space-y-3 relative">
                          <div class="watermark"></div>
                          <h2 class="text-2xl font-bold text-green-700 text-center mb-4">🎉 Selamat! Induksi Selesai 🎉</h2>
                          <div class="flex flex-col md:flex-row gap-4 items-center">
                              <div class="flex-1 space-y-2">
                                  <p><span class="font-semibold w-28 inline-block">Nama</span>: ${
                                    state.userData.nama
                                  }</p>
                                  <p><span class="font-semibold w-28 inline-block">Perusahaan</span>: ${
                                    state.userData.perusahaan
                                  }</p>
                                  <p><span class="font-semibold w-28 inline-block">Jenis Induksi</span>: ${inductionText}</p>
                                  <p><span class="font-semibold w-28 inline-block">Jam Submit</span>: ${formattedTime} WITA</p>
                                  <p><span class="font-semibold w-28 inline-block">Skor Akhir</span>: <strong>${state.quizData.finalScore.toFixed(
                                    2
                                  )}</strong></p>
                              </div>
                              <div class="p-2 bg-white border rounded-lg">
                                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=NIK:${
                                    state.userData.nik
                                  },Nama:${
          state.userData.nama
        }" alt="QR Code" class="mx-auto">
                              </div>
                          </div>
                         </div>
                         <p class="mt-6 font-semibold text-center text-gray-700">Sertifikat ini bersifat pribadi dan tidak untuk disebarluaskan.</p>
                         <button id="download-pdf-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Unduh Sertifikat (PDF)</button>`;

        dom.completionScreen.innerHTML = content;

        const watermarkContainer =
          dom.completionScreen.querySelector(".watermark");
        const watermarkText = `${state.userData.nama} - ${state.userData.perusahaan}`;
        for (let i = 0; i < 15; i++) {
          // Mengurangi jumlah watermark
          const item = document.createElement("div");
          item.className = "watermark-item";
          item.textContent = watermarkText;
          watermarkContainer.appendChild(item);
        }

        setTimeout(triggerConfetti, 100);

        const pdfButton = document.getElementById("download-pdf-btn");
        if (pdfButton) {
          pdfButton.addEventListener("click", generateCertificatePDF);
        }
        localStorage.removeItem("inductionAppState");
      }

      async function generateCertificatePDF() {
        showLoader("Membuat sertifikat PDF...");
        const doc = new jsPDF();
        const { nama, perusahaan, timestamp } = state.userData;
        const inductionText =
          inductionTypeMap[state.userData.inductionType] ||
          state.userData.inductionType;
        const date = new Date(timestamp);
        const formattedDate = date.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
        const formattedTime = date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.text("SERTIFIKAT PENYELESAIAN INDUKSI", 105, 30, {
          align: "center",
        });

        doc.setFontSize(14);
        doc.text("PT. Ganda Alam Makmur", 105, 40, { align: "center" });

        doc.setLineWidth(0.5);
        doc.line(20, 45, 190, 45);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text("Dengan ini menyatakan bahwa:", 105, 60, { align: "center" });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text(nama, 105, 80, { align: "center" });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(`Dari perusahaan: ${perusahaan}`, 105, 90, {
          align: "center",
        });

        doc.text("Telah berhasil menyelesaikan:", 105, 110, {
          align: "center",
        });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(inductionText, 105, 120, { align: "center" });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(
          `Pada tanggal ${formattedDate}, pukul ${formattedTime} WITA`,
          105,
          140,
          { align: "center" }
        );
        doc.text(`Dengan skor akhir:`, 105, 150, { align: "center" });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.text(state.quizData.finalScore.toFixed(2), 105, 160, {
          align: "center",
        });

        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=NIK:${state.userData.nik},Nama:${state.userData.nama}`;
        try {
          const qrCodeDataUrl = await getImageDataUrl(qrCodeUrl);
          doc.addImage(qrCodeDataUrl, "PNG", 85, 180, 40, 40);
        } catch (error) {
          console.error("Gagal memuat QR code untuk PDF:", error);
          doc.text("[Gagal memuat QR Code]", 105, 200, { align: "center" });
        }

        doc.setFontSize(10);
        doc.setTextColor(150);
        doc.text(
          "Sertifikat ini dibuat secara otomatis oleh sistem.",
          105,
          280,
          { align: "center" }
        );

        doc.save(`Sertifikat_Induksi_${nama}.pdf`);
        hideLoader();
      }

      function getImageDataUrl(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.height = img.naturalHeight;
            canvas.width = img.naturalWidth;
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL("image/png"));
          };
          img.onerror = () => {
            reject(new Error("Gagal memuat gambar dari URL: " + url));
          };
          img.src = url;
        });
      }

      // --- NETWORK & OFFLINE HANDLING ---

      async function postDataWithOfflineQueue(request) {
        if (WEB_APP_URL === "GANTI_DENGAN_URL_WEB_APP_ANDA") {
          const msg = "URL Web App belum dikonfigurasi.";
          if (request.action === "getSoal") throw new Error(msg);
          showAlert(msg);
          addToOfflineQueue(request);
          return;
        }
        if (state.isOnline) {
          try {
            const response = await fetch(WEB_APP_URL, {
              method: "POST",
              mode: "cors",
              cache: "no-cache",
              redirect: "follow",
              headers: {
                "Content-Type": "text/plain;charset=utf-8",
              },
              body: JSON.stringify(request),
            });
            if (!response.ok)
              throw new Error(`Server error: ${response.statusText}`);
            const result = await response.json();
            if (result.status !== "success")
              throw new Error(result.message || "Unknown server error");
            return result.data;
          } catch (error) {
            console.error("API call failed, saving to offline queue:", error);
            if (request.action === "getSoal") throw error;
            addToOfflineQueue(request);
          }
        } else {
          if (request.action === "getSoal")
            throw new Error("Tidak bisa memuat soal saat offline.");
          addToOfflineQueue(request);
        }
      }

      function addToOfflineQueue(request) {
        const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        queue.push(request);
        localStorage.setItem("offlineQueue", JSON.stringify(queue));
        showAlert(
          "Koneksi terputus. Data Anda disimpan sementara dan akan dikirim saat kembali online."
        );
      }

      async function syncOfflineData() {
        const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        if (queue.length === 0) return;
        showLoader(`Menyinkronkan ${queue.length} data offline...`);
        const failedSync = [];
        for (const request of queue) {
          try {
            await postDataWithOfflineQueue(request);
          } catch (error) {
            failedSync.push(request);
          }
        }
        localStorage.setItem("offlineQueue", JSON.stringify(failedSync));
        hideLoader();
        if (failedSync.length === 0) {
          showAlert("Semua data yang tersimpan berhasil diunggah.");
        } else {
          showAlert(
            `Gagal mengunggah ${failedSync.length} data. Akan dicoba lagi nanti.`
          );
        }
      }

      function checkOnlineStatus() {
        state.isOnline = navigator.onLine;
        dom.onlineStatus.textContent = state.isOnline
          ? "● Online"
          : "● Offline";
        dom.onlineStatus.className = `mt-2 text-sm font-semibold rounded-full px-3 py-1 inline-block ${
          state.isOnline
            ? "bg-green-100 text-green-800"
            : "bg-red-100 text-red-800"
        }`;
        if (state.isOnline) syncOfflineData();
      }

      // --- MISC HELPERS ---

      function loadTallyForms() {
        // Cek apakah src sudah mengandung URL Tally untuk mencegah reload yang tidak perlu
        if (dom.signatureFrame.dataset.tallySrc) {
          return;
        }

        const { nik, nama, perusahaan, jabatan } = state.userData;
        // Pastikan data pengguna ada sebelum membuat URL
        if (!nik || !nama || !perusahaan) {
          console.error(
            "Data pengguna tidak lengkap untuk memuat formulir Tally."
          );
          // Untuk admin, kita bisa isi dengan data dummy
          if (state.isAdminMode) {
            const queryParams = `?nik=ADMIN&nama=ADMIN&perusahaan=ADMIN&jabatan=ADMIN`;
            dom.signatureFrame.dataset.tallySrc =
              TALLY_SIGNATURE_URL + queryParams;
            if (typeof Tally !== "undefined") Tally.loadEmbeds();
          }
          return;
        }

        const queryParams = `?nik=${encodeURIComponent(
          nik
        )}&nama=${encodeURIComponent(nama)}&perusahaan=${encodeURIComponent(
          perusahaan
        )}&jabatan=${encodeURIComponent(jabatan || "")}`;

        dom.signatureFrame.dataset.tallySrc = TALLY_SIGNATURE_URL + queryParams;
        if (typeof Tally !== "undefined") Tally.loadEmbeds();
      }

      function loadCachedUserInfo() {
        if (state.currentStep > 0) return;

        const cachedInfo = localStorage.getItem("cachedUserInfo");
        if (cachedInfo) {
          const userInfo = JSON.parse(cachedInfo);

          dom.userInfoForm.elements["nik"].value = userInfo.nik || "";
          dom.userInfoForm.elements["nama"].value = userInfo.nama || "";
          dom.userInfoForm.elements["email"].value = userInfo.email || "";
          dom.userInfoForm.elements["whatsapp"].value = userInfo.whatsapp || "";
          dom.userInfoForm.elements["jabatan"].value = userInfo.jabatan || "";

          const perusahaanSelect =
            dom.userInfoForm.elements["perusahaan-select"];
          const perusahaanLainnyaInput =
            dom.userInfoForm.elements["perusahaan-lainnya"];
          const perusahaanLainnyaContainer = document.getElementById(
            "perusahaan-lainnya-container"
          );

          const isStandardCompany = [...perusahaanSelect.options].some(
            (opt) => opt.value === userInfo.perusahaan
          );

          if (isStandardCompany) {
            perusahaanSelect.value = userInfo.perusahaan;
            perusahaanLainnyaContainer.classList.add("hidden");
            perusahaanLainnyaInput.required = false;
          } else if (userInfo.perusahaan) {
            perusahaanSelect.value = "Lainnya";
            perusahaanLainnyaContainer.classList.remove("hidden");
            perusahaanLainnyaInput.value = userInfo.perusahaan;
            perusahaanLainnyaInput.required = true;
          }
        }
      }

      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
