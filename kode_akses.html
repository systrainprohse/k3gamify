<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- PWA Tags -->
    <meta name="theme-color" content="#4f46e5" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png" />

    <title>Verifikasi Kode Akses</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Menggunakan font Inter untuk tampilan yang lebih modern */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Style untuk loading spinner */
      .loader {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Animasi fade-in untuk container */
      .form-container {
        animation: fadeIn 0.8s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Animasi goyang saat terjadi error */
      .shake {
        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        transform: translate3d(0, 0, 0);
      }
      @keyframes shake {
        10%,
        90% {
          transform: translate3d(-1px, 0, 0);
        }
        20%,
        80% {
          transform: translate3d(2px, 0, 0);
        }
        30%,
        50%,
        70% {
          transform: translate3d(-4px, 0, 0);
        }
        40%,
        60% {
          transform: translate3d(4px, 0, 0);
        }
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-gray-50 to-indigo-100 flex items-center justify-center min-h-screen p-4"
  >
    <div
      class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md form-container border border-gray-200"
    >
      <div class="text-center mb-8">
        <!-- Icon Kunci -->
        <div class="flex justify-center mb-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-16 w-16 text-blue-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
            />
          </svg>
        </div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">
          Verifikasi Kode
        </h1>
        <p class="text-gray-500 mt-2">
          Masukkan kode akses yang dikirim melalui WhatsApp <br />
          <strong class="text-gray-700">082223089790 "k3gamify"</strong>.
        </p>
      </div>

      <!-- Form untuk memasukkan kode akses -->
      <form id="access-form">
        <div class="mb-6">
          <label
            for="access-code"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Kode Akses Anda</label
          >
          <input
            type="text"
            id="access-code"
            name="access-code"
            placeholder="••••••••"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300 shadow-sm"
          />
        </div>

        <!-- Tombol Submit -->
        <button
          type="submit"
          id="submit-button"
          class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center"
        >
          <span id="button-text">Verifikasi & Masuk</span>
          <div id="loader" class="loader hidden ml-3"></div>
        </button>
      </form>

      <!-- Pesan error atau sukses -->
      <div id="message" class="mt-6 text-center text-sm font-medium h-5"></div>
    </div>

    <script>
      // URL Google Sheet
      const sheetUrl =
        "https://docs.google.com/spreadsheets/d/1tuTh3lLiPYAUOJwCTpvsag6jqt9TZXuieSjI2Q1T42A/gviz/tq?tqx=out:csv&sheet=kode_akses";

      // Mengambil elemen dari DOM
      const form = document.getElementById("access-form");
      const accessCodeInput = document.getElementById("access-code");
      const messageDiv = document.getElementById("message");
      const submitButton = document.getElementById("submit-button");
      const buttonText = document.getElementById("button-text");
      const loader = document.getElementById("loader");

      /**
       * Fungsi untuk memformat tanggal menjadi YYYY-MM-DD
       * @param {Date} date - Objek tanggal
       * @returns {string} - Tanggal yang sudah diformat
       */
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      /**
       * Fungsi untuk menangani proses submit form
       * @param {Event} event - Event submit
       */
      async function handleFormSubmit(event) {
        event.preventDefault();

        loader.classList.remove("hidden");
        buttonText.textContent = "Memeriksa...";
        submitButton.disabled = true;
        accessCodeInput.disabled = true;
        messageDiv.textContent = "";
        messageDiv.className = "mt-6 text-center text-sm font-medium h-5";

        const enteredCode = accessCodeInput.value.trim();
        const todayDateStr = formatDate(new Date());

        try {
          const response = await fetch(sheetUrl);
          if (!response.ok) throw new Error("Gagal terhubung ke server data.");

          const csvText = await response.text();
          if (!csvText || csvText.trim() === "")
            throw new Error("Tidak ada data yang diterima.");

          const rows = csvText.trim().split("\n").slice(1);
          let validCodeFound = false;

          for (const row of rows) {
            if (!row.trim()) continue;
            const columns = row
              .split(",")
              .map((col) => col.trim().replace(/^"|"$/g, ""));

            if (columns.length > 2) {
              const dateFromSheet = columns[1];
              const codeFromSheet = columns[2];

              // Memeriksa kecocokan tanggal dan kode
              if (
                dateFromSheet === todayDateStr &&
                codeFromSheet === enteredCode
              ) {
                validCodeFound = true;
                break; // Keluar dari loop jika sudah ditemukan
              }
            }
          }

          if (validCodeFound) {
            messageDiv.textContent = "Verifikasi berhasil! Mengarahkan...";
            messageDiv.classList.add("text-green-600");
            // Arahkan ke halaman induksi
            setTimeout(() => {
              window.location.href = "induksi.html";
            }, 1500);
          } else {
            throw new Error(
              "Kode akses salah atau tidak valid untuk hari ini."
            );
          }
        } catch (error) {
          messageDiv.textContent = error.message;
          messageDiv.classList.add("text-red-600");

          // Menambahkan animasi goyang saat error
          document.querySelector(".form-container").classList.add("shake");
          setTimeout(() => {
            document.querySelector(".form-container").classList.remove("shake");
          }, 500);

          loader.classList.add("hidden");
          buttonText.textContent = "Verifikasi & Masuk";
          submitButton.disabled = false;
          accessCodeInput.disabled = false;
        }
      }

      if (form) {
        form.addEventListener("submit", handleFormSubmit);
      }

      // --- PWA Service Worker Registration ---
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "Service Worker berhasil didaftarkan: ",
                registration
              );
            })
            .catch((error) => {
              console.log("Pendaftaran Service Worker gagal: ", error);
            });
        });
      }
    </script>
  </body>
</html>
