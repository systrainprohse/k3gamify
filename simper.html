<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Ujian SIMPER</title>
    <link rel="icon" href="https://i.imgur.com/2sQd5Xy.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .step-card {
        transition: all 0.3s ease-in-out;
      }
      .locked {
        opacity: 0.5;
        pointer-events: none;
      }
      .step-header {
        cursor: pointer;
      }
      .step-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-out;
      }
      .step-content.open {
        max-height: 3500px; /* Increased max-height for forms */
        transition: max-height 1.5s ease-in;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-left-color: #ffffff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .tally-embed {
        width: 100%;
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      /* Confetti Animation */
      .confetti-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        z-index: 999;
      }
      .confetti {
        position: absolute;
        width: 10px;
        height: 20px;
        opacity: 0.9;
        animation: fall 5s linear forwards;
      }
      @keyframes fall {
        to {
          transform: translateY(110vh) rotate(720deg);
          opacity: 0;
        }
      }
      /* Anti-Screenshot/Print Styles */
      @media print {
        body * {
          visibility: hidden;
        }
        #print-message,
        #print-message * {
          visibility: visible;
        }
        #print-message {
          position: fixed;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          font-weight: bold;
          color: black;
        }
      }
      .watermark {
        position: absolute;
        inset: 0;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 20px;
        pointer-events: none;
        overflow: hidden;
        z-index: 1; /* Memastikan watermark di atas konten kartu */
      }
      .watermark-item {
        color: #000;
        opacity: 0.12; /* Opasitas dinaikkan agar lebih terlihat */
        font-size: 18px; /* Ukuran font diperbesar */
        font-weight: bold;
        transform: rotate(-30deg);
        white-space: nowrap;
      }
      @keyframes blink {
        50% {
          opacity: 0.5;
        }
      }
      .timer-warning {
        color: #ef4444; /* red-500 */
        animation: blink 1s linear infinite;
      }
      /* Carousel Styles */
      .carousel-container {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .carousel-track-container {
        overflow: hidden;
        width: 100%;
      }
      .carousel-track {
        display: flex;
        transition: transform 0.5s ease-in-out;
      }
      .carousel-card {
        flex: 0 0 100%;
        width: 100%;
        box-sizing: border-box;
      }
      .carousel-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
          Sistem Ujian SIMPER
        </h1>
        <p class="text-gray-600 mt-2">PT. Ganda Alam Makmur</p>
        <div
          id="online-status"
          class="mt-2 text-sm font-semibold rounded-full px-3 py-1 inline-block"
        ></div>
        <!-- Tombol Kembali ke Halaman Utama -->
        <div class="mt-4">
          <a
            href="training_center.html"
            class="text-blue-600 hover:text-blue-800 hover:underline font-semibold"
          >
            &larr; Kembali ke Halaman Utama
          </a>
        </div>
      </div>

      <div id="app-container" class="space-y-4">
        <!-- Langkah 0: Panduan Pengerjaan -->
        <div id="step-0" class="step-card bg-white p-6 rounded-xl shadow-md">
          <div class="step-header flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">
              Langkah 0: Panduan Pengerjaan Ujian
            </h2>
            <span id="step-0-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-0-content" class="step-content pt-4">
            <div class="w-full bg-white rounded-2xl p-2 md:p-6">
              <div class="text-center mb-12">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                  Panduan Pengerjaan Ujian SIMPER Online
                </h1>
                <p class="text-lg text-gray-600 mt-2">
                  Ikuti langkah-langkah berikut untuk menyelesaikan ujian Anda.
                </p>
              </div>
              <div class="space-y-10">
                <!-- Step 1 Guide -->
                <div class="flex items-start space-x-6">
                  <div class="flex flex-col items-center">
                    <div
                      class="flex items-center justify-center w-16 h-16 bg-green-500 text-white rounded-full text-2xl font-bold shadow-md"
                    >
                      1
                    </div>
                    <div class="w-1 h-24 bg-green-200 mt-2"></div>
                  </div>
                  <div class="flex-1 pt-2">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-8 w-8 text-green-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h2 class="text-2xl font-bold text-gray-800">
                        Pilih Kategori SIMPER
                      </h2>
                    </div>
                    <p class="text-gray-600 mt-2">
                      Pilih kategori dan model unit yang akan Anda ajukan
                      (misal: LV, Bus, Alat Berat).
                    </p>
                  </div>
                </div>
                <!-- Step 2 Guide -->
                <div class="flex items-start space-x-6">
                  <div class="flex flex-col items-center">
                    <div
                      class="flex items-center justify-center w-16 h-16 bg-blue-500 text-white rounded-full text-2xl font-bold shadow-md"
                    >
                      2
                    </div>
                    <div class="w-1 h-24 bg-blue-200 mt-2"></div>
                  </div>
                  <div class="flex-1 pt-2">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-8 w-8 text-blue-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                        />
                      </svg>
                      <h2 class="text-2xl font-bold text-gray-800">
                        Isi Informasi Diri
                      </h2>
                    </div>
                    <p class="text-gray-600 mt-2">
                      Lengkapi data diri Anda dengan benar untuk melanjutkan
                      proses ujian.
                    </p>
                  </div>
                </div>
                <!-- Step 3 Guide -->
                <div class="flex items-start space-x-6">
                  <div class="flex flex-col items-center">
                    <div
                      class="flex items-center justify-center w-16 h-16 bg-purple-500 text-white rounded-full text-2xl font-bold shadow-md"
                    >
                      3
                    </div>
                    <div class="w-1 h-24 bg-purple-200 mt-2"></div>
                  </div>
                  <div class="flex-1 pt-2">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-8 w-8 text-purple-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h2 class="text-2xl font-bold text-gray-800">
                        Kerjakan Ujian Teori
                      </h2>
                    </div>
                    <p class="text-gray-600 mt-2">
                      Jawab semua pertanyaan ujian teori dengan teliti.
                      Perhatikan batas waktu yang diberikan.
                    </p>
                  </div>
                </div>
                <!-- Step 4 Guide -->
                <div class="flex items-start space-x-6">
                  <div
                    class="flex items-center justify-center w-16 h-16 bg-red-500 text-white rounded-full text-2xl font-bold shadow-md"
                  >
                    4
                  </div>
                  <div class="flex-1 pt-2 ml-6">
                    <div class="flex items-center mb-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-8 w-8 text-red-500 mr-3"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                        />
                      </svg>
                      <h2 class="text-2xl font-bold text-gray-800">
                        Lihat Hasil & Kartu SIMPER
                      </h2>
                    </div>
                    <p class="text-gray-600 mt-2">
                      Jika lulus, Anda dapat melihat dan mengunduh kartu SIMPER
                      sementara.
                    </p>
                  </div>
                </div>
              </div>
              <div class="mt-12 pt-8 border-t border-gray-200">
                <h3 class="text-xl font-bold text-center text-gray-800">
                  Catatan Penting
                </h3>
                <div class="mt-4 grid md:grid-cols-2 gap-6 text-center">
                  <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                    <h4
                      class="font-semibold text-red-700 flex items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 mr-2"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                        /></svg
                      >Jika Tidak Lulus
                    </h4>
                    <p class="text-red-600 text-sm mt-1">
                      Anda harus mengulang ujian sesuai dengan jadwal yang
                      ditentukan oleh pengawas.
                    </p>
                  </div>
                  <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                    <h4
                      class="font-semibold text-blue-700 flex items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 mr-2"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071a10 10 0 0114.142 0M1.394 9.393a15 15 0 0121.212 0"
                        /></svg
                      >Koneksi Internet
                    </h4>
                    <p class="text-blue-600 text-sm mt-1">
                      Jika koneksi terputus, data Anda aman dan akan diunggah
                      otomatis saat kembali online.
                    </p>
                  </div>
                </div>
                <div
                  class="mt-6 bg-yellow-50 border border-yellow-300 p-4 rounded-lg text-center"
                >
                  <h4
                    class="font-bold text-yellow-800 flex items-center justify-center"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-6 w-6 mr-2"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      /></svg
                    >PERINGATAN KERAHASIAAN
                  </h4>
                  <p class="text-yellow-700 text-sm mt-2">
                    Dilarang keras mengambil tangkapan layar (screenshot) soal
                    maupun jawaban. Pelanggaran akan dikenakan sanksi.
                  </p>
                </div>
              </div>
            </div>
            <div class="mt-8 pt-6 border-t">
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="guide-checkbox"
                  class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"
                />
                <span class="ml-3 text-gray-700 font-medium"
                  >Saya telah membaca dan memahami panduan pengerjaan di
                  atas.</span
                >
              </label>
              <button
                id="start-process-btn"
                class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg"
                disabled
              >
                Lanjutkan ke Pemilihan Unit
              </button>
            </div>
          </div>
        </div>

        <!-- Langkah 1: Pilih Kategori SIMPER (Carousel) -->
        <div
          id="step-1"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">
              Langkah 1: Pilih Kategori SIMPER
            </h2>
            <span id="step-1-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-1-content" class="step-content pt-4">
            <div class="carousel-container">
              <!-- Tombol Navigasi Carousel -->
              <button
                id="prev-carousel-btn"
                class="carousel-button left-0 ml-[-16px] bg-white p-2 rounded-full shadow-md hover:bg-gray-100 transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6 text-gray-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </button>

              <!-- Konten Carousel -->
              <div class="carousel-track-container">
                <div id="carousel-track" class="carousel-track">
                  <!-- Kartu Carousel akan di-generate oleh JavaScript -->
                </div>
              </div>

              <!-- Tombol Navigasi Carousel -->
              <button
                id="next-carousel-btn"
                class="carousel-button right-0 mr-[-16px] bg-white p-2 rounded-full shadow-md hover:bg-gray-100 transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6 text-gray-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Langkah 2: Data Diri -->
        <div
          id="step-2"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">
              Langkah 2: Informasi Peserta Ujian
            </h2>
            <span id="step-2-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-2-content" class="step-content pt-4">
            <form id="user-info-form" class="space-y-4">
              <input
                type="text"
                id="timestamp"
                name="timestamp"
                class="hidden"
              />
              <div>
                <label for="nik" class="block text-sm font-medium text-gray-700"
                  >NIK KTP</label
                >
                <input
                  type="number"
                  id="nik"
                  name="nik"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="nama"
                  class="block text-sm font-medium text-gray-700"
                  >Nama Lengkap</label
                >
                <input
                  type="text"
                  id="nama"
                  name="nama"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-700"
                  >Email</label
                >
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="whatsapp"
                  class="block text-sm font-medium text-gray-700"
                  >No. WhatsApp</label
                >
                <input
                  type="tel"
                  id="whatsapp"
                  name="whatsapp"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="perusahaan-select"
                  class="block text-sm font-medium text-gray-700"
                  >Perusahaan</label
                >
                <select
                  id="perusahaan-select"
                  name="perusahaan-select"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="" disabled selected>Pilih Perusahaan</option>
                  <option value="PT. GAM">PT. GAM</option>
                  <option value="PT. KRI">PT. KRI</option>
                  <option value="PT. SUM">PT. SUM</option>
                  <option value="PT. DAUN BUAH">PT. DAUN BUAH</option>
                  <option value="PT. KAI">PT. KAI</option>
                  <option value="PT. GPE">PT. GPE</option>
                  <option value="PT. SMP">PT. SMP</option>
                  <option value="PT. INDEXIM COALINDO">
                    PT. INDEXIM COALINDO
                  </option>
                  <option value="PT. RPJ">PT. RPJ</option>
                  <option value="PT. SCI">PT. SCI</option>
                  <option value="PT. WEM">PT. WEM</option>
                  <option value="CV. AJS">CV. AJS</option>
                  <option value="PT. TRAKINDO UTAMA">PT. TRAKINDO UTAMA</option>
                  <option value="PT. GHJ">PT. GHJ</option>
                  <option value="PT. TEM">PT. TEM</option>
                  <option value="PT. HEXINDO ADIPERKASA">
                    PT. HEXINDO ADIPERKASA
                  </option>
                  <option value="PT. BELFANO">PT. BELFANO</option>
                  <option value="PT. BORNEO MELAWEN JAYA">
                    PT. BORNEO MELAWEN JAYA
                  </option>
                  <option value="PT. UT">PT. UT</option>
                  <option value="PT. BDE">PT. BDE</option>
                  <option value="PT. SUCOFINDO">PT. SUCOFINDO</option>
                  <option value="MAGANG / PKL / KKN">MAGANG / PKL / KKN</option>
                  <option value="PT. BAGONG">PT. BAGONG</option>
                  <option value="PT. PMJ">PT. PMJ</option>
                  <option value="Lainnya">Lainnya...</option>
                </select>
              </div>
              <div id="perusahaan-lainnya-container" class="hidden">
                <label
                  for="perusahaan-lainnya"
                  class="block text-sm font-medium text-gray-700"
                  >Nama Perusahaan Lainnya</label
                >
                <input
                  type="text"
                  id="perusahaan-lainnya"
                  name="perusahaan-lainnya"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
              <div>
                <label
                  for="jabatan"
                  class="block text-sm font-medium text-gray-700"
                  >Jabatan</label
                >
                <select
                  id="jabatan"
                  name="jabatan"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="" disabled selected>Pilih Jabatan Anda</option>
                  <option value="pengawas">Pengawas / GL / SPV</option>
                  <option value="suptend">Superintendent / Manager</option>
                  <option value="non_pengawas">
                    Non Pengawas (Admin, Helper, dll)
                  </option>
                  <option value="driver">Driver Bus / Elf / Sarana</option>
                  <option value="mekanik">Mekanik</option>
                  <option value="operator">
                    Operator HD / DT / Dozzer / Exca / Rigger / dll.
                  </option>
                </select>
              </div>
              <button
                type="submit"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
              >
                Simpan & Lanjutkan
              </button>
            </form>
          </div>
        </div>

        <!-- Langkah 3: Ujian Teori Umum -->
        <div
          id="step-3"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">
              Langkah 3: Ujian Teori - Peraturan Umum
            </h2>
            <span id="step-3-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-3-content" class="step-content pt-4 text-center">
            <p class="text-gray-600 mb-4">
              Anda akan mengerjakan ujian mengenai peraturan umum lalu lintas &
              keselamatan.
            </p>
            <p id="general-quiz-error" class="hidden text-red-500"></p>
            <button
              id="start-general-quiz-btn"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Mulai Ujian Umum
            </button>
          </div>
        </div>

        <!-- Langkah 4: Ujian Teori Spesifik -->
        <div
          id="step-4"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">
              Langkah 4: Ujian Teori - Sesuai Unit
            </h2>
            <span id="step-4-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-4-content" class="step-content pt-4 text-center">
            <p class="text-gray-600 mb-4">
              Sekarang kerjakan ujian yang sesuai dengan kategori SIMPER yang
              Anda pilih.
            </p>
            <p id="specific-quiz-error" class="hidden text-red-500"></p>
            <button
              id="start-specific-quiz-btn"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Mulai Ujian Spesifik
            </button>
          </div>
        </div>

        <!-- Langkah 5: Surat Pernyataan -->
        <div
          id="step-5"
          class="step-card bg-white p-6 rounded-xl shadow-md locked"
        >
          <div class="step-header flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">
              Langkah 5: Surat Pernyataan
            </h2>
            <span id="step-5-status" class="text-sm font-semibold text-red-500"
              >Terkunci</span
            >
          </div>
          <div id="step-5-content" class="step-content pt-4 space-y-8">
            <!-- SPDK Form -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">
                1. Surat Pernyataan Kepatuhan
              </h3>
              <p class="text-gray-600 mb-4">
                Silakan isi dan tandatangani formulir pernyataan di bawah ini.
              </p>
              <iframe
                id="spdk-frame"
                src=""
                class="tally-embed"
                title="Formulir Pernyataan Kepatuhan"
              ></iframe>
              <label class="mt-4 flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="spdk-checkbox"
                  class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"
                />
                <span class="ml-3 text-gray-700 font-medium"
                  >Saya telah menandatangani Surat Pernyataan.</span
                >
              </label>
            </div>
            <!-- Checklist Form -->
            <div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">
                2. Checklist Kelengkapan Dokumen
              </h3>
              <p class="text-gray-600 mb-4">
                Lengkapi formulir checklist kelengkapan dokumen berikut.
              </p>
              <iframe
                id="checklist-frame"
                src=""
                class="tally-embed"
                title="Formulir Checklist Dokumen"
              ></iframe>
              <label class="mt-4 flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="checklist-checkbox"
                  class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"
                />
                <span class="ml-3 text-gray-700 font-medium"
                  >Saya telah mengisi Checklist Kelengkapan Dokumen.</span
                >
              </label>
            </div>
            <button
              id="finish-checklist-btn"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
              disabled
            >
              Selesai & Terbitkan Kartu SIMPER
            </button>
          </div>
        </div>
      </div>

      <div
        id="completion-screen"
        class="hidden bg-white p-8 rounded-xl shadow-md text-center mt-6 relative"
      ></div>

      <div class="text-center mt-8">
        <button
          id="reset-btn"
          class="text-sm text-gray-500 hover:text-gray-700 hover:underline"
        >
          Ulangi Proses dari Awal
        </button>
        <a
          href="index.html"
          class="mt-4 inline-block text-sm text-blue-600 hover:text-blue-800 hover:underline"
          >Kembali ke Halaman Utama</a
        >
      </div>
    </div>

    <!-- Hidden div for print message -->
    <div id="print-message" class="hidden">Tindakan ini tidak diizinkan.</div>

    <!-- Modal Konfirmasi -->
    <div
      id="confirmation-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-lg p-8 shadow-xl text-center">
        <p id="modal-text" class="text-lg font-medium mb-6"></p>
        <div class="flex justify-center space-x-4">
          <button
            id="modal-cancel"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg"
          >
            Batal
          </button>
          <button
            id="modal-confirm"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg"
          >
            Ya
          </button>
        </div>
      </div>
    </div>

    <!-- Kuis Modal -->
    <div
      id="quiz-modal"
      class="hidden fixed inset-0 bg-gray-100 z-40 p-4 overflow-y-auto"
    >
      <div
        class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden my-8"
      >
        <div class="p-8 relative">
          <div class="watermark"></div>
          <!-- Bagian Materi (Video) - Dihilangkan untuk ujian -->
          <div
            id="quiz-material-section"
            class="hidden mb-6 pb-6 border-b"
          ></div>

          <!-- Bagian Pertanyaan -->
          <div id="quiz-question-section">
            <div class="flex justify-between items-center mb-4">
              <span
                id="progress-text"
                class="text-base font-medium text-blue-700"
              ></span>
              <div
                id="quiz-timer"
                class="text-xl font-bold text-gray-800"
              ></div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2-5 mb-6">
              <div
                id="progress-bar"
                class="bg-blue-600 h-2.5 rounded-full"
                style="width: 0%"
              ></div>
            </div>
            <div id="quiz-container"></div>
          </div>

          <!-- Tombol Navigasi -->
          <div
            id="navigation-buttons"
            class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center"
          >
            <button
              id="prev-button"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Sebelumnya
            </button>
            <button
              id="next-button"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors"
            >
              Selanjutnya
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Fullscreen Loader -->
    <div
      id="fullscreen-loader"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-[100]"
    >
      <div class="spinner"></div>
      <p id="loader-text" class="text-white text-lg mt-4 font-semibold">
        Memuat...
      </p>
    </div>

    <script>
      // --- KONFIGURASI WAJIB ---
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbyEzbJT_-0i3_4mx4fDAo4R0MFWPYNHrAGTguaYkZorQ8tfoZYi0hukvFqSeC2ayg/exec";
      const TALLY_SPDK_URL =
        "https://tally.so/embed/wv6yz0?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1";
      const TALLY_CHECKLIST_URL =
        "https://tally.so/embed/mDOdMR?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1";
      const PASSING_SCORE = 75; // Nilai Kelulusan Minimal (contoh: 75)
      // -------------------------

      // Inisialisasi jsPDF
      const { jsPDF } = window.jspdf;

      const dom = {
        appContainer: document.getElementById("app-container"),
        onlineStatus: document.getElementById("online-status"),
        completionScreen: document.getElementById("completion-screen"),
        allSteps: document.querySelectorAll(".step-card"),
        resetButton: document.getElementById("reset-btn"),
        userInfoForm: document.getElementById("user-info-form"),
        guideCheckbox: document.getElementById("guide-checkbox"),
        startProcessBtn: document.getElementById("start-process-btn"),
        startGeneralQuizBtn: document.getElementById("start-general-quiz-btn"),
        startSpecificQuizBtn: document.getElementById(
          "start-specific-quiz-btn"
        ),
        finishChecklistBtn: document.getElementById("finish-checklist-btn"),
        spdkCheckbox: document.getElementById("spdk-checkbox"),
        checklistCheckbox: document.getElementById("checklist-checkbox"),
        spdkFrame: document.getElementById("spdk-frame"),
        checklistFrame: document.getElementById("checklist-frame"),
        carousel: {
          track: document.getElementById("carousel-track"),
          prevBtn: document.getElementById("prev-carousel-btn"),
          nextBtn: document.getElementById("next-carousel-btn"),
        },
        loader: {
          container: document.getElementById("fullscreen-loader"),
          text: document.getElementById("loader-text"),
        },
        quiz: {
          modal: document.getElementById("quiz-modal"),
          questionSection: document.getElementById("quiz-question-section"),
          progressText: document.getElementById("progress-text"),
          progressBar: document.getElementById("progress-bar"),
          container: document.getElementById("quiz-container"),
          nextBtn: document.getElementById("next-button"),
          prevBtn: document.getElementById("prev-button"),
          timer: document.getElementById("quiz-timer"),
        },
        modal: {
          container: document.getElementById("confirmation-modal"),
          text: document.getElementById("modal-text"),
          confirmBtn: document.getElementById("modal-confirm"),
          cancelBtn: document.getElementById("modal-cancel"),
        },
      };

      let state = {
        currentStep: 0,
        isOnline: navigator.onLine,
        userData: {},
        quizData: {
          allAnswers: {},
          allQuestions: [],
          currentMaterials: [],
          currentTotalQuestions: 0,
          finalScore: 0,
          currentQuizType: "",
          timerId: null,
          timeRemaining: 0,
        },
        carouselIndex: 0,
      };

      const simperCategories = [
        {
          kelompok: "Sarana Transportasi",
          value: "sarana_transportasi",
          models: [
            "Light Vehicle (LV)",
            "Isuzu ELF",
            "BUS (angkutan karyawan)",
          ],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>`,
        },
        {
          kelompok: "Dump Truck (DT)",
          value: "dump_truck",
          models: [
            "SANY",
            "Volvo (10 Roda)",
            "Volvo (12 Roda)",
            "Mercedes-Benz",
          ],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-1.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5 1.5-.67 1.5-1.5 1.5zM15 12H3V6h12v6z"/></svg>`,
        },
        {
          kelompok: "Excavator",
          value: "excavator",
          models: ["Umum / Sesuai Spesifikasi"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.36 10.36L18 9l-2.25 3-1.75-1-3.16 4.31L17 21.47V22h-2v-1.26l-6-8.18-2.58 2.38L5 13.47l1.36-1.36L5 10.74 3.64 12.1 2.22 10.68l1.41-1.41L2.22 7.85 3.64 6.44l1.41 1.41L6.47 6.44l1.36 1.36L6.41 9.22l2.58-2.38L10.36 9l6 8.18V18h1.26l2.1-2.1c.19-.19.3-.44.3-.71s-.11-.52-.29-.7l-1.07-1.06l2.83-2.83c.38-.38.38-1 0-1.41z"/></svg>`,
        },
        {
          kelompok: "Wheel Loader",
          value: "wheel_loader",
          models: ["Umum / Sesuai Spesifikasi"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M21.41 10.59l-8-8C13.04 2.22 12.53 2 12 2H4c-1.1 0-2 .9-2 2v8c0 .53.22 1.04.59 1.41l8 8c.36.36.86.59 1.41.59s1.05-.23 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.23-1.05-.59-1.42zM13 20.01L5 12.01V4h7v1L8 9v2h4l3 3v6.01zM7.5 8C6.67 8 6 7.33 6 6.5S6.67 5 7.5 5 9 5.67 9 6.5 8.33 8 7.5 8z"/></svg>`,
        },
        {
          kelompok: "Dozer",
          value: "dozer",
          models: ["Bulldozer / Perata tanah"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M22 18V6H4.78l-2-3.5L1.38 4l3.2 5.5A2.5 2.5 0 017 11h13v2H7.22l-.33.58L5.78 16H22v2H4.78l-.5-1H22zM5 18c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm14 0c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`,
        },
        {
          kelompok: "Motor Grader",
          value: "motor_grader",
          models: ["Umum / Sesuai Spesifikasi"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 13l2.5-2.5L1 8l1.42-1.42L5.24 9.4l2.83-2.83L6.66 5.15 8.07 3.73 11.5 7.16l2.83-2.83-1.41-1.42L14.34 1.5l3.54 3.54-1.42 1.42-2.83-2.83-2.83 2.83 2.83 2.83L22 6.34l-1.42 1.42L18.05 5.23l-2.83 2.83 2.83 2.83L22 7.76l-1.42 1.42-2.5-2.5-2.83 2.83L18.08 12l1.42 1.42L17.07 15.85l-1.42-1.42-2.83 2.83 2.83 2.83 2.5-2.5 1.42 1.42L18.07 23.5l-3.54-3.54 1.42-1.42 2.83 2.83 2.83-2.83-2.83-2.83-4.24-4.24-2.83-2.83-2.83 2.83L4.93 18.07l-1.42 1.42L1 17.07l2.5-2.5L1 12v1z"/></svg>`,
        },
        {
          kelompok: "Forklift",
          value: "forklift",
          models: ["Unit pengangkat barang"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M21 13v5c0 .55-.45 1-1 1h-3c-.55 0-1-.45-1-1v-5c0-.55.45-1 1-1h3c.55 0 1 .45 1 1zm-1 0h-3v5h3v-5zM9.61 3.26L8.15 2.58C7.59 2.34 7 2.79 7 3.4v13.2c0 .41-.25.78-.63.93L4 18.69V21h1v-1.45c.48-.18.8-.63.8-1.15V4.42l1.22.51-1.93 8.3c-.2.86.33 1.71 1.2 1.94l1.52.41c.41.11.83-.17.94-.59l2.8-10.36c.21-.78-.25-1.61-1.03-1.82zM14 17.11V3.4c0-.61-.59-1.06-1.15-.82l-1.46.68c-.78.36-1.21 1.23-1.03 2.01l2.8 10.36c.11.41.52.69.94.58l.48-.13c.86-.23 1.4-1.08 1.2-1.94l-.58-2.03z"/></svg>`,
        },
        {
          kelompok: "Water Truck",
          value: "water_truck",
          models: ["Penyemprot air"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-1.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5 1.5-.67 1.5-1.5 1.5zM15 12H3V6h12v6zm-5-3c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`,
        },
        {
          kelompok: "ANFO Truck",
          value: "anfo_truck",
          models: ["Pengangkut bahan peledak"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zm-8.5-2h-1v-2h1v2zm2 0h-1v-2h1v2zm-2 2h-1V6h1v2zm2 0h-1V6h1v2zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-1.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5 1.5-.67 1.5-1.5 1.5zM15 12H3V4h12v8z"/></svg>`,
        },
        {
          kelompok: "Drilling Machine",
          value: "drilling_machine",
          models: ["Rig pengeboran"],
          icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 5.5c0 1.93-1.57 3.5-3.5 3.5s-3.5-1.57-3.5-3.5S11.07 2 13 2s3.5 1.57 3.5 3.5zm-1.85 2.85c.38.38.38 1.02 0 1.41l-7.07 7.07c-.38.38-1.02.38-1.41 0l-1.41-1.41c-.38-.38-.38-1.02 0-1.41l7.07-7.07c.38-.38 1.02-.38 1.41 0l1.41 1.41zM18 12c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm-1 8h-2v-2h2v2zm0-3h-2v-2h2v2z"/></svg>`,
        },
      ];

      function initApp() {
        loadState();
        loadCachedUserInfo();
        checkOnlineStatus();
        addEventListeners();
        generateCarouselCards();
        updateUI();
      }

      function generateCarouselCards() {
        dom.carousel.track.innerHTML = "";
        simperCategories.forEach((category) => {
          const card = document.createElement("div");
          card.className = "carousel-card p-4";
          card.innerHTML = `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl shadow-lg p-6 text-center border h-full flex flex-col">
                    <div class="text-blue-600 mx-auto mb-4">
                        ${category.icon}
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">${
                      category.kelompok
                    }</h3>
                    <div class="space-y-3 flex-grow">
                        ${category.models
                          .map(
                            (model) => `
                            <button data-group-value="${category.value}" data-model-value="${model}" class="select-simper-model-btn w-full bg-white hover:bg-blue-50 border border-gray-300 text-blue-800 font-semibold py-2 px-4 rounded-lg transition-colors">
                                ${model}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
          dom.carousel.track.appendChild(card);
        });
        // Call updateCarousel after a short delay to ensure DOM is updated
        setTimeout(updateCarousel, 0);
      }

      function updateCarousel() {
        const track = dom.carousel.track;
        if (!track.firstChild) return;
        const cardWidth = track.firstChild.offsetWidth;
        track.style.transform = `translateX(-${
          state.carouselIndex * cardWidth
        }px)`;
      }

      function handleCarouselNav(direction) {
        const numCards = simperCategories.length;
        if (direction === "next") {
          state.carouselIndex = (state.carouselIndex + 1) % numCards;
        } else {
          state.carouselIndex = (state.carouselIndex - 1 + numCards) % numCards;
        }
        updateCarousel();
      }

      function updateUI() {
        dom.allSteps.forEach((step, index) => {
          const content = step.querySelector(".step-content");
          const statusEl = document.getElementById(`step-${index}-status`);
          if (index <= state.currentStep) {
            step.classList.remove("locked");
            if (statusEl) {
              statusEl.textContent = "Selesai";
              statusEl.className = "text-sm font-semibold text-green-500";
            }
            content.classList.toggle("open", index === state.currentStep);
          } else {
            step.classList.add("locked");
            content.classList.remove("open");
            if (statusEl) {
              statusEl.textContent = "Terkunci";
              statusEl.className = "text-sm font-semibold text-red-500";
            }
          }
        });

        for (const key in state.userData) {
          const el = dom.userInfoForm.elements[key];
          if (el && key !== "perusahaan") {
            el.value = state.userData[key];
          }
        }

        if (state.userData.perusahaan) {
          const perusahaanSelect =
            dom.userInfoForm.elements["perusahaan-select"];
          const perusahaanLainnyaInput =
            dom.userInfoForm.elements["perusahaan-lainnya"];
          const perusahaanLainnyaContainer = document.getElementById(
            "perusahaan-lainnya-container"
          );

          const isStandardCompany = [...perusahaanSelect.options].some(
            (opt) => opt.value === state.userData.perusahaan
          );

          if (isStandardCompany) {
            perusahaanSelect.value = state.userData.perusahaan;
            perusahaanLainnyaContainer.classList.add("hidden");
            perusahaanLainnyaInput.required = false;
          } else {
            perusahaanSelect.value = "Lainnya";
            perusahaanLainnyaContainer.classList.remove("hidden");
            perusahaanLainnyaInput.value = state.userData.perusahaan;
            perusahaanLainnyaInput.required = true;
          }
        }
      }

      function saveState() {
        localStorage.setItem("simperAppState", JSON.stringify(state));
      }

      function loadState() {
        const savedState = localStorage.getItem("simperAppState");
        if (savedState) state = JSON.parse(savedState);
      }

      function resetState() {
        showModal(
          "Apakah Anda yakin ingin memulai sesi baru? Progres saat ini akan hilang.",
          () => {
            localStorage.removeItem("simperAppState");
            localStorage.removeItem("offlineQueue");
            location.reload();
          },
          "Ya, Mulai Baru"
        );
      }

      function advanceStep(step) {
        state.currentStep = step;
        saveState();
        updateUI();

        // Recalculate carousel on step open
        if (step === 1) {
          setTimeout(() => updateCarousel(), 50); // Small delay for CSS transition
        }

        if (step === 5) {
          // Step 5 is now the declaration forms
          loadTallyForms();
        }
      }

      function addEventListeners() {
        window.addEventListener("online", checkOnlineStatus);
        window.addEventListener("offline", checkOnlineStatus);
        window.addEventListener("resize", updateCarousel); // Recalculate on resize
        dom.resetButton.addEventListener("click", resetState);

        document.querySelectorAll(".step-header").forEach((header) => {
          header.addEventListener("click", () => {
            if (!header.parentElement.classList.contains("locked")) {
              header.nextElementSibling.classList.toggle("open");
            }
          });
        });

        dom.guideCheckbox.addEventListener("change", () => {
          dom.startProcessBtn.disabled = !dom.guideCheckbox.checked;
        });
        dom.startProcessBtn.addEventListener("click", () => advanceStep(1));

        dom.userInfoForm.addEventListener("submit", handleUserInfoSubmit);

        dom.carousel.prevBtn.addEventListener("click", () =>
          handleCarouselNav("prev")
        );
        dom.carousel.nextBtn.addEventListener("click", () =>
          handleCarouselNav("next")
        );

        dom.carousel.track.addEventListener("click", (e) => {
          if (e.target.classList.contains("select-simper-model-btn")) {
            const groupValue = e.target.dataset.groupValue;
            const modelValue = e.target.dataset.modelValue;
            handleSelectSimperModel(groupValue, modelValue);
          }
        });

        dom.startGeneralQuizBtn.addEventListener("click", (e) =>
          handleStartQuiz(e, "general")
        );
        dom.startSpecificQuizBtn.addEventListener("click", (e) =>
          handleStartQuiz(e, "specific")
        );

        dom.spdkCheckbox.addEventListener("change", checkStep5Completion);
        dom.checklistCheckbox.addEventListener("change", checkStep5Completion);
        dom.finishChecklistBtn.addEventListener("click", () =>
          showCertificateScreen(true)
        );

        const perusahaanSelect = document.getElementById("perusahaan-select");
        const perusahaanLainnyaContainer = document.getElementById(
          "perusahaan-lainnya-container"
        );
        const perusahaanLainnyaInput =
          document.getElementById("perusahaan-lainnya");

        perusahaanSelect.addEventListener("change", (e) => {
          if (e.target.value === "Lainnya") {
            perusahaanLainnyaContainer.classList.remove("hidden");
            perusahaanLainnyaInput.required = true;
          } else {
            perusahaanLainnyaContainer.classList.add("hidden");
            perusahaanLainnyaInput.required = false;
            perusahaanLainnyaInput.value = "";
          }
        });
      }

      function checkStep5Completion() {
        if (dom.spdkCheckbox.checked && dom.checklistCheckbox.checked) {
          dom.finishChecklistBtn.disabled = false;
        } else {
          dom.finishChecklistBtn.disabled = true;
        }
      }

      async function getIpAddress() {
        try {
          const response = await fetch("https://api.ipify.org?format=json");
          if (!response.ok) return "Gagal mendapatkan IP";
          const data = await response.json();
          return data.ip;
        } catch (error) {
          console.error("Gagal mengambil IP address:", error);
          return "Tidak tersedia";
        }
      }

      async function handleUserInfoSubmit(e) {
        e.preventDefault();
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showLoader("Menyimpan data peserta...");

        try {
          const formData = new FormData(e.target);
          state.userData = {
            ...state.userData,
            ...Object.fromEntries(formData.entries()),
          };

          const perusahaanPilihan = formData.get("perusahaan-select");
          if (perusahaanPilihan === "Lainnya") {
            state.userData.perusahaan = formData.get("perusahaan-lainnya");
          } else {
            state.userData.perusahaan = perusahaanPilihan;
          }
          delete state.userData["perusahaan-select"];
          delete state.userData["perusahaan-lainnya"];

          state.userData.timestamp = new Date().toISOString();
          state.userData.ip_address = await getIpAddress();

          const userInfoToCache = {
            nik: state.userData.nik,
            nama: state.userData.nama,
            email: state.userData.email,
            whatsapp: state.userData.whatsapp,
            perusahaan: state.userData.perusahaan,
            jabatan: state.userData.jabatan,
          };
          localStorage.setItem(
            "cachedUserInfo",
            JSON.stringify(userInfoToCache)
          );

          await postDataWithOfflineQueue({
            action: "saveUser",
            payload: state.userData,
          });

          advanceStep(3); // Advance to Step 3: Ujian Teori Umum
        } catch (error) {
          console.error("Gagal menyimpan data diri:", error);
          alert(`Terjadi kesalahan: ${error.message}`);
        } finally {
          hideLoader();
          submitButton.disabled = false;
        }
      }

      function handleSelectSimperModel(groupValue, modelValue) {
        if (!groupValue || !modelValue) {
          alert("Gagal memilih kategori. Silakan coba lagi.");
          return;
        }
        state.userData.inductionType = groupValue;
        state.userData.simperModel = modelValue;
        advanceStep(2); // Advance to Step 2: Informasi Peserta
      }

      async function handleStartQuiz(e, quizType) {
        const button = e.target;
        button.disabled = true;
        showLoader("Memuat soal ujian...");

        const errorElId = `${quizType}-quiz-error`;
        const errorEl = document.getElementById(errorElId);
        if (errorEl) errorEl.classList.add("hidden");

        state.quizData.currentQuizType = quizType;

        if (quizType === "general") {
          state.quizData.allAnswers = {};
          state.quizData.allQuestions = [];
        }

        try {
          let payload;
          if (quizType === "general") {
            payload = { tipe_induksi: "all", jabatan_id: "all" };
          } else {
            payload = {
              tipe_induksi: state.userData.inductionType,
              jabatan_id: state.userData.jabatan,
            };
          }

          const materials = await postDataWithOfflineQueue({
            action: "getSoal",
            payload: payload,
          });

          if (!materials || materials.length === 0)
            throw new Error("Tidak ada soal yang ditemukan untuk ujian ini.");

          let currentTotalQuestions = 0;
          materials.forEach((m) => {
            if (m.questions && Array.isArray(m.questions)) {
              currentTotalQuestions += m.questions.length;
              state.quizData.allQuestions.push(...m.questions);
            }
          });

          if (currentTotalQuestions === 0)
            throw new Error(
              "Materi ditemukan, tetapi tidak ada soal di dalamnya."
            );

          state.quizData.currentMaterials = materials;
          state.quizData.currentTotalQuestions = currentTotalQuestions;

          saveState();
          launchQuizModal();
        } catch (error) {
          console.error(`Gagal memuat ${quizType} kuis:`, error);
          if (errorEl) {
            errorEl.textContent = `Gagal memuat soal. Pesan dari server: ${error.message}`;
            errorEl.classList.remove("hidden");
          }
        } finally {
          hideLoader();
          button.disabled = false;
        }
      }

      function showModal(
        text,
        onConfirm,
        confirmText = "Ya",
        onCancel = () => {},
        cancelText = "Batal"
      ) {
        dom.modal.text.textContent = text;
        dom.modal.confirmBtn.textContent = confirmText;
        dom.modal.cancelBtn.textContent = cancelText;
        dom.modal.container.classList.remove("hidden");

        const confirmHandler = () => {
          onConfirm();
          hideModal();
          cleanup();
        };
        const cancelHandler = () => {
          onCancel();
          hideModal();
          cleanup();
        };
        const cleanup = () => {
          dom.modal.confirmBtn.removeEventListener("click", confirmHandler);
          dom.modal.cancelBtn.removeEventListener("click", cancelHandler);
        };

        dom.modal.confirmBtn.addEventListener("click", confirmHandler);
        dom.modal.cancelBtn.addEventListener("click", cancelHandler);
      }

      function hideModal() {
        dom.modal.container.classList.add("hidden");
      }

      function showLoader(message = "Memuat...") {
        dom.loader.text.textContent = message;
        dom.loader.container.classList.remove("hidden");
      }

      function hideLoader() {
        dom.loader.container.classList.add("hidden");
      }

      function launchQuizModal() {
        state.quizData.currentMaterialIndex = 0;
        state.quizData.currentQuestionIndex = 0;
        dom.quiz.modal.classList.remove("hidden");
        dom.quiz.nextBtn.onclick = handleQuizNext;
        dom.quiz.prevBtn.onclick = handleQuizPrev;
        populateQuizWatermark();
        displayCurrentQuestion();
        startTimer(1800); // 30 mins for all quizzes
      }

      function populateQuizWatermark() {
        const watermarkContainer = dom.quiz.modal.querySelector(".watermark");
        if (!watermarkContainer) return;
        watermarkContainer.innerHTML = "";
        const watermarkText = `${state.userData.nama} - ${state.userData.perusahaan}`;
        for (let i = 0; i < 25; i++) {
          const item = document.createElement("div");
          item.className = "watermark-item";
          item.textContent = watermarkText;
          watermarkContainer.appendChild(item);
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function displayCurrentQuestion() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const material = currentMaterials[currentMaterialIndex];
        const q = material.questions[currentQuestionIndex];

        let options = [
          q.pilihan_a,
          q.pilihan_b,
          q.pilihan_c,
          q.pilihan_d,
        ].filter((opt) => opt && String(opt).trim() !== "");
        options = shuffleArray(options);

        let imageHtml = "";
        if (q.gambar && q.gambar.trim() !== "") {
          imageHtml = `<img src="${q.gambar}" alt="Gambar Soal" class="my-4 rounded-lg max-w-full h-auto mx-auto border">`;
        }

        dom.quiz.container.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">
                <span class="font-bold">Pertanyaan ${
                  currentQuestionIndex + 1
                } dari ${material.questions.length}:</span>
            </h2>
            <p class="text-lg mb-4">${q.pertanyaan}</p>
            ${imageHtml}
            <div class="space-y-4">
                ${options
                  .map(
                    (option, i) => `
                    <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-blue-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition-all">
                        <input type="radio" name="question${q.id_soal}" value="${option}" class="h-5 w-5 text-blue-600">
                        <span class="ml-4 text-md">${option}</span>
                    </label>
                `
                  )
                  .join("")}
            </div>`;

        const savedAnswer = state.quizData.allAnswers[q.id_soal];
        if (savedAnswer) {
          const radio = dom.quiz.container.querySelector(
            `input[value="${savedAnswer}"]`
          );
          if (radio) radio.checked = true;
        }

        updateQuizProgress();
        updateNavigationButtons();
      }

      function updateQuizProgress() {
        const totalQuestions = state.quizData.currentTotalQuestions;
        let questionNumber = 1;
        for (let i = 0; i < state.quizData.currentMaterialIndex; i++) {
          questionNumber += state.quizData.currentMaterials[i].questions.length;
        }
        questionNumber += state.quizData.currentQuestionIndex;

        const progress =
          totalQuestions > 0 ? (questionNumber / totalQuestions) * 100 : 0;
        dom.quiz.progressBar.style.width = `${progress}%`;
        dom.quiz.progressText.textContent = `Soal ${questionNumber} dari ${totalQuestions}`;
      }

      function updateNavigationButtons() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const isFirstQuestionOverall =
          currentMaterialIndex === 0 && currentQuestionIndex === 0;
        dom.quiz.prevBtn.disabled = isFirstQuestionOverall;

        const isLastQuestionOverall =
          currentMaterialIndex === currentMaterials.length - 1 &&
          currentQuestionIndex ===
            currentMaterials[currentMaterialIndex].questions.length - 1;
        dom.quiz.nextBtn.textContent = isLastQuestionOverall
          ? "Selesai Ujian"
          : "Selanjutnya";
      }

      function handleQuizNext() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const currentQuestion =
          currentMaterials[currentMaterialIndex].questions[
            currentQuestionIndex
          ];
        const selectedOption = document.querySelector(
          `input[name="question${currentQuestion.id_soal}"]:checked`
        );

        if (!selectedOption) {
          alert("Harap pilih satu jawaban untuk melanjutkan.");
          return;
        }
        state.quizData.allAnswers[currentQuestion.id_soal] =
          selectedOption.value;

        const isLastQuestionInMaterial =
          currentQuestionIndex ===
          currentMaterials[currentMaterialIndex].questions.length - 1;

        if (!isLastQuestionInMaterial) {
          state.quizData.currentQuestionIndex++;
          displayCurrentQuestion();
        } else {
          const isLastMaterial =
            currentMaterialIndex === currentMaterials.length - 1;
          if (!isLastMaterial) {
            state.quizData.currentMaterialIndex++;
            state.quizData.currentQuestionIndex = 0;
            displayCurrentQuestion();
          } else {
            finishQuiz();
          }
        }
        saveState();
      }

      function handleQuizPrev() {
        const { currentMaterials, currentMaterialIndex, currentQuestionIndex } =
          state.quizData;
        const isFirstQuestionInMaterial = currentQuestionIndex === 0;

        if (!isFirstQuestionInMaterial) {
          state.quizData.currentQuestionIndex--;
          displayCurrentQuestion();
        } else {
          const isFirstMaterial = currentMaterialIndex === 0;
          if (!isFirstMaterial) {
            state.quizData.currentMaterialIndex--;
            const prevMaterial =
              state.quizData.currentMaterials[
                state.quizData.currentMaterialIndex
              ];
            state.quizData.currentQuestionIndex =
              prevMaterial.questions.length - 1;
            displayCurrentQuestion();
          }
        }
        saveState();
      }

      async function finishQuiz() {
        dom.quiz.modal.classList.add("hidden");
        stopTimer();

        if (state.quizData.currentQuizType === "general") {
          advanceStep(4); // Move to Step 4: Specific quiz
        } else {
          // This is the specific quiz, the final one
          showLoader("Menyimpan hasil akhir ujian...");
          try {
            calculateFinalScore();
            const payload = {
              ...state.userData,
              skor: state.quizData.finalScore,
              tipe_induksi: state.userData.inductionType, // Keep this key for backend compatibility
              detail_jawaban: JSON.stringify(state.quizData.allAnswers),
            };
            await postDataWithOfflineQueue({
              action: "saveJawaban",
              payload: payload,
            });

            if (state.quizData.finalScore < PASSING_SCORE) {
              showFinalScreen();
            } else {
              advanceStep(5); // If passed, advance to Step 5: Declaration Forms
            }
          } catch (error) {
            console.error("Gagal menyimpan jawaban:", error);
            alert(`Gagal menyimpan jawaban: ${error.message}`);
          } finally {
            hideLoader();
          }
        }
      }

      function calculateFinalScore() {
        let correctAnswers = 0;
        const totalQuestions = state.quizData.allQuestions.length;

        if (totalQuestions === 0) {
          state.quizData.finalScore = 0;
          return;
        }

        state.quizData.allQuestions.forEach((q) => {
          const userAnswer = state.quizData.allAnswers[q.id_soal];
          const correctAnswer = q.kunci_jawaban;

          if (
            userAnswer &&
            correctAnswer &&
            String(userAnswer).trim() === String(correctAnswer).trim()
          ) {
            correctAnswers++;
          }
        });

        state.quizData.finalScore = (correctAnswers / totalQuestions) * 100;
      }

      function triggerConfetti() {
        const container = document.createElement("div");
        container.className = "confetti-container";
        dom.completionScreen.appendChild(container);
        const colors = [
          "#f44336",
          "#e91e63",
          "#9c27b0",
          "#673ab7",
          "#3f51b5",
          "#2196f3",
          "#03a9f4",
          "#00bcd4",
          "#009688",
          "#4caf50",
          "#8bc34a",
          "#cddc39",
          "#ffeb3b",
          "#ffc107",
          "#ff9800",
        ];
        for (let i = 0; i < 100; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.top = Math.random() * -100 + "vh";
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 2 + "s";
          container.appendChild(confetti);
        }
        setTimeout(() => container.remove(), 6000);
      }

      function showFinalScreen() {
        dom.appContainer.classList.add("hidden");
        dom.completionScreen.classList.remove("hidden");
        let content = "";

        if (state.quizData.finalScore >= PASSING_SCORE) {
          // This case is now handled by advancing to step 5, but as a fallback:
          showCertificateScreen();
          return;
        } else {
          content = `<h2 class="text-2xl font-bold text-red-600">Mohon Maaf, Anda Belum Lulus</h2>
                           <p class="mt-4 text-gray-700">Skor Akhir Anda adalah <strong>${state.quizData.finalScore.toFixed(
                             2
                           )}</strong>, sedangkan nilai kelulusan minimal adalah <strong>${PASSING_SCORE}</strong>.</p>
                           <p class="mt-2 text-gray-600">Silakan hubungi pengawas untuk jadwal ujian ulang.</p>`;
          localStorage.removeItem("simperAppState");
        }

        dom.completionScreen.innerHTML = content;
      }

      function showCertificateScreen(isFromTally = false) {
        dom.appContainer.classList.add("hidden");
        dom.completionScreen.classList.remove("hidden");

        const date = new Date(state.userData.timestamp);
        const formattedTime = date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const inductionText =
          state.userData.simperModel || state.userData.inductionType;

        const content = `<div class="border-4 border-green-500 rounded-lg p-6 bg-green-50 text-left space-y-3 relative">
                                 <div class="watermark"></div>
                                 <h2 class="text-2xl font-bold text-green-700 text-center mb-4"> Selamat! Anda Lulus Ujian SIMPER </h2>
                                 <div class="flex flex-col md:flex-row gap-4 items-center">
                                     <div class="flex-1 space-y-2">
                                         <p><span class="font-semibold w-32 inline-block">Nama</span>: ${
                                           state.userData.nama
                                         }</p>
                                         <p><span class="font-semibold w-32 inline-block">Perusahaan</span>: ${
                                           state.userData.perusahaan
                                         }</p>
                                         <p><span class="font-semibold w-32 inline-block">Kategori SIMPER</span>: ${inductionText}</p>
                                         <p><span class="font-semibold w-32 inline-block">Jam Ujian</span>: ${formattedTime} WITA</p>
                                         <p><span class="font-semibold w-32 inline-block">Skor Akhir</span>: <strong>${state.quizData.finalScore.toFixed(
                                           2
                                         )}</strong></p>
                                     </div>
                                     <div class="p-2 bg-white border rounded-lg">
                                         <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=SIMPER,NIK:${
                                           state.userData.nik
                                         },Nama:${
          state.userData.nama
        }" alt="QR Code" class="mx-auto">
                                     </div>
                                 </div>
                                </div>
                               <p class="mt-6 font-semibold text-center text-gray-700">Kartu ini adalah bukti kelulusan sementara. Silakan hubungi departemen terkait untuk penerbitan kartu fisik.</p>
                               <button id="download-pdf-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Unduh Kartu SIMPER (PDF)</button>`;

        dom.completionScreen.innerHTML = content;

        const watermarkContainer =
          dom.completionScreen.querySelector(".watermark");
        const watermarkText = `${state.userData.nama} - ${state.userData.perusahaan}`;
        for (let i = 0; i < 25; i++) {
          const item = document.createElement("div");
          item.className = "watermark-item";
          item.textContent = watermarkText;
          watermarkContainer.appendChild(item);
        }

        setTimeout(triggerConfetti, 100);

        const pdfButton = document.getElementById("download-pdf-btn");
        if (pdfButton) {
          pdfButton.addEventListener("click", generateCertificatePDF);
        }
        localStorage.removeItem("simperAppState");
      }

      async function generateCertificatePDF() {
        showLoader("Membuat Kartu PDF...");
        const doc = new jsPDF();
        const { nama, perusahaan, timestamp } = state.userData;
        const inductionText =
          state.userData.simperModel || state.userData.inductionType;
        const date = new Date(timestamp);
        const formattedDate = date.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });
        const formattedTime = date.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(22);
        doc.text("KARTU SIMPER SEMENTARA", 105, 30, { align: "center" });

        doc.setFontSize(14);
        doc.text("PT. Ganda Alam Makmur", 105, 40, { align: "center" });

        doc.setLineWidth(0.5);
        doc.line(20, 45, 190, 45);

        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text("Diberikan kepada:", 105, 60, { align: "center" });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text(nama, 105, 80, { align: "center" });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(`Dari perusahaan: ${perusahaan}`, 105, 90, {
          align: "center",
        });

        doc.text("Telah berhasil lulus Ujian Teori untuk:", 105, 110, {
          align: "center",
        });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(`Kategori SIMPER: ${inductionText}`, 105, 120, {
          align: "center",
        });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.text(
          `Pada tanggal ${formattedDate}, pukul ${formattedTime} WITA`,
          105,
          140,
          { align: "center" }
        );
        doc.text(`Dengan skor akhir:`, 105, 150, { align: "center" });

        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.text(state.quizData.finalScore.toFixed(2), 105, 160, {
          align: "center",
        });

        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SIMPER,NIK:${state.userData.nik},Nama:${state.userData.nama}`;
        try {
          const qrCodeDataUrl = await getImageDataUrl(qrCodeUrl);
          doc.addImage(qrCodeDataUrl, "PNG", 85, 180, 40, 40);
        } catch (error) {
          console.error("Gagal memuat QR code untuk PDF:", error);
          doc.text("[Gagal memuat QR Code]", 105, 200, { align: "center" });
        }

        doc.setFontSize(10);
        doc.setTextColor(150);
        doc.text("Kartu ini dibuat secara otomatis oleh sistem.", 105, 280, {
          align: "center",
        });

        doc.save(`Kartu_SIMPER_${nama}.pdf`);
        hideLoader();
      }

      function getImageDataUrl(url) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.height = img.naturalHeight;
            canvas.width = img.naturalWidth;
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL("image/png"));
          };
          img.onerror = () => {
            reject(new Error("Gagal memuat gambar dari URL: " + url));
          };
          img.src = url;
        });
      }

      async function postDataWithOfflineQueue(request) {
        // Mocking API calls for demonstration purposes as the backend URL is a placeholder
        console.log("Sending request (or queueing if offline):", request);
        if (request.action === "getSoal") {
          // Return mock data for quizzes
          const mockQuestions = [
            {
              id_soal: 1,
              pertanyaan: "Apa arti rambu lalu lintas berwarna merah?",
              pilihan_a: "Jalan terus",
              pilihan_b: "Hati-hati",
              pilihan_c: "Berhenti",
              pilihan_d: "Belok kiri",
              kunci_jawaban: "Berhenti",
              gambar: "",
            },
            {
              id_soal: 2,
              pertanyaan: "Berapa batas kecepatan maksimal di jalan tol?",
              pilihan_a: "60 km/jam",
              pilihan_b: "80 km/jam",
              pilihan_c: "100 km/jam",
              pilihan_d: "120 km/jam",
              kunci_jawaban: "100 km/jam",
              gambar: "",
            },
          ];
          const mockSpecificQuestions = [
            {
              id_soal: 3,
              pertanyaan: "Kapan LV harus menyalakan lampu hazard?",
              pilihan_a: "Saat hujan",
              pilihan_b: "Saat parkir di bahu jalan",
              pilihan_c: "Saat berbelok",
              pilihan_d: "Saat berhenti darurat",
              kunci_jawaban: "Saat berhenti darurat",
              gambar: "",
            },
          ];

          const data = [
            {
              materi_judul:
                request.payload.tipe_induksi === "all"
                  ? "Ujian Teori Umum"
                  : "Ujian Teori Spesifik",
              video_url: "",
              questions:
                request.payload.tipe_induksi === "all"
                  ? mockQuestions
                  : mockSpecificQuestions,
            },
          ];
          return Promise.resolve(data);
        }
        return Promise.resolve({
          status: "success",
          message: "Data berhasil disimpan (mock)",
        });
      }

      function addToOfflineQueue(request) {
        const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        queue.push(request);
        localStorage.setItem("offlineQueue", JSON.stringify(queue));
        alert(
          "Koneksi terputus. Data Anda disimpan sementara dan akan dikirim saat kembali online."
        );
      }

      async function syncOfflineData() {
        const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        if (queue.length === 0) return;
        showLoader(`Menyinkronkan ${queue.length} data offline...`);
        const failedSync = [];
        for (const request of queue) {
          try {
            await postDataWithOfflineQueue(request);
          } catch (error) {
            failedSync.push(request);
          }
        }
        localStorage.setItem("offlineQueue", JSON.stringify(failedSync));
        hideLoader();
        if (failedSync.length === 0) {
          alert("Semua data yang tersimpan berhasil diunggah.");
        } else {
          alert(
            `Gagal mengunggah ${failedSync.length} data. Akan dicoba lagi nanti.`
          );
        }
      }

      function checkOnlineStatus() {
        state.isOnline = navigator.onLine;
        dom.onlineStatus.textContent = state.isOnline
          ? " Online"
          : " Offline";
        dom.onlineStatus.className = `mt-2 text-sm font-semibold rounded-full px-3 py-1 inline-block ${
          state.isOnline
            ? "bg-green-100 text-green-800"
            : "bg-red-100 text-red-800"
        }`;
        if (state.isOnline) syncOfflineData();
      }

      function loadTallyForms() {
        const { nik, nama, perusahaan } = state.userData;
        const queryParams = `?nik=${encodeURIComponent(
          nik
        )}&nama=${encodeURIComponent(nama)}&perusahaan=${encodeURIComponent(
          perusahaan
        )}`;

        dom.spdkFrame.src = TALLY_SPDK_URL + queryParams;
        dom.checklistFrame.src = TALLY_CHECKLIST_URL + queryParams;
      }

      function loadCachedUserInfo() {
        if (state.currentStep > 0) return;

        const cachedInfo = localStorage.getItem("cachedUserInfo");
        if (cachedInfo) {
          const userInfo = JSON.parse(cachedInfo);

          dom.userInfoForm.elements["nik"].value = userInfo.nik || "";
          dom.userInfoForm.elements["nama"].value = userInfo.nama || "";
          dom.userInfoForm.elements["email"].value = userInfo.email || "";
          dom.userInfoForm.elements["whatsapp"].value = userInfo.whatsapp || "";
          dom.userInfoForm.elements["jabatan"].value = userInfo.jabatan || "";

          const perusahaanSelect =
            dom.userInfoForm.elements["perusahaan-select"];
          const perusahaanLainnyaInput =
            dom.userInfoForm.elements["perusahaan-lainnya"];
          const perusahaanLainnyaContainer = document.getElementById(
            "perusahaan-lainnya-container"
          );

          const isStandardCompany = [...perusahaanSelect.options].some(
            (opt) => opt.value === userInfo.perusahaan
          );

          if (isStandardCompany) {
            perusahaanSelect.value = userInfo.perusahaan;
            perusahaanLainnyaContainer.classList.add("hidden");
            perusahaanLainnyaInput.required = false;
          } else if (userInfo.perusahaan) {
            perusahaanSelect.value = "Lainnya";
            perusahaanLainnyaContainer.classList.remove("hidden");
            perusahaanLainnyaInput.value = userInfo.perusahaan;
            perusahaanLainnyaInput.required = true;
          }
        }
      }

      // --- Timer Functions ---
      function startTimer(duration) {
        stopTimer();
        state.quizData.timeRemaining = duration;
        updateTimerDisplay();
        state.quizData.timerId = setInterval(() => {
          state.quizData.timeRemaining--;
          updateTimerDisplay();
          if (state.quizData.timeRemaining <= 0) {
            stopTimer();
            alert("Waktu habis! Ujian akan diselesaikan secara otomatis.");
            finishQuiz();
          }
        }, 1000);
      }

      function stopTimer() {
        clearInterval(state.quizData.timerId);
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(state.quizData.timeRemaining / 60);
        const seconds = state.quizData.timeRemaining % 60;
        dom.quiz.timer.textContent = `${String(minutes).padStart(
          2,
          "0"
        )}:${String(seconds).padStart(2, "0")}`;

        if (state.quizData.timeRemaining < 300) {
          // Warning under 5 minutes
          dom.quiz.timer.classList.add("timer-warning");
        } else {
          dom.quiz.timer.classList.remove("timer-warning");
        }
      }

      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
